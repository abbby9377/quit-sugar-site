<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é›»å­æ›¸å•†åº—ï½œQuit Sugar</title>
  <meta name="description" content="æˆ’ç³–ä¸»é¡Œé›»å­æ›¸å•†åº—ï¼šä¸€æ¬¡å…¥æ‰‹ 8 é€±æˆ’ç³–å…¥é–€ã€ä½ç³–æ—©é¤ã€å¤–é£Ÿå°‘ç³–ã€é›¶ç³–ç”œé»ç­‰å¯¦ç”¨æŒ‡å—ã€‚æ”¯æ´è³¼ç‰©è»Šèˆ‡å¥—çµ„å„ªæƒ ï¼Œçµå¸³å°å‘ Google è¡¨å–®æ”¶å–®ã€‚" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
  :root{
    --bg:#ffffff; --card:#ffffff; --muted:#475569; --text:#0f172a;
    --brand:#ec4899; --brand-2:#f472b6; --brand-3:#fb7185;
    --accent:#fdf2f8; --line:#e5e7eb; --danger:#ef4444; --ok:#16a34a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:'Noto Sans TC',system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
  .wrap{max-width:1080px;margin:0 auto;padding:32px 20px 80px}
  header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--brand-2),var(--brand-3));display:grid;place-items:center;color:#fff;font-weight:900}
  h1{margin:0;font-size:24px;letter-spacing:0.5px}
  .muted{color:var(--muted)}
  .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);padding:12px 16px;border-radius:999px;background:#f8fafc;color:var(--text);cursor:pointer;white-space:nowrap}
  .btn.primary{background:linear-gradient(135deg,var(--brand-2),var(--brand));color:#fff;border:none;font-weight:700}
  .btn.ghost{background:transparent}
  .btn.danger{background:linear-gradient(135deg,#ef4444,#b91c1c);border:none;color:#fff}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  nav.top-nav{display:flex;gap:16px;align-items:center;padding:8px 0 14px;margin:0 0 16px;border-bottom:1px solid var(--line)}
  nav.top-nav a{color:#2563eb;text-decoration:none}
  nav.top-nav a:hover{text-decoration:underline}
  nav.top-nav .active{font-weight:700;color:#1d4ed8}

  /* Hero */
  .hero{background:var(--accent);border:1px solid var(--line);border-radius:24px;padding:24px;margin:8px 0 22px;position:relative}
  .hero h2{font-size:28px;margin:0 0 8px}
  .hero p{margin:0 0 14px}
  .hero .actions{display:flex;gap:10px;flex-wrap:wrap}
  @media(min-width:900px){
    .hero{display:grid;grid-template-columns:1.3fr 1fr;gap:20px;align-items:center}
    .hero-media{justify-self:end}
  }
  .hero-media img{width:100%;max-width:420px;height:auto;border-radius:20px;box-shadow:0 10px 30px rgba(236,72,153,.15)}

  /* Filter / sort */
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;justify-content:space-between;align-items:center;margin:10px 0 12px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
  .chip.active{border-color:#d946ef;color:#a21caf;background:#fdf4ff}
  select.sort{border:1px solid var(--line);border-radius:12px;padding:8px 10px;background:#fff}

  /* Grid */
  .grid{display:grid;gap:14px;grid-template-columns:repeat(2,1fr)}
  @media(min-width:960px){ .grid{grid-template-columns:repeat(3,1fr)} }
  .card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 6px 20px rgba(236,72,153,.08)}
  .product .cover{width:100%;height:auto;border-radius:12px;display:block;border:1px solid var(--line)}
  .product h4{margin:8px 0 6px;font-size:16px}
  .price{display:flex;gap:8px;align-items:center}
  .price .now{font-weight:800}
  .price .was{color:#94a3b8;text-decoration:line-through}
  .badges{display:flex;gap:6px;flex-wrap:wrap;margin:4px 0}
  .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff}
  .badge.sale{color:#b91c1c;border-color:#fecaca;background:#fff1f2}
  .badge.new{color:#065f46;border-color:#bbf7d0;background:#ecfdf5}

  /* Bundle banner */
  .bundle{position:relative;display:grid;gap:10px;grid-template-columns:1fr;align-items:center;
          border:1px solid var(--line);border-radius:20px;padding:18px;margin:14px 0 18px;
          background:linear-gradient(135deg,#fff1f2,#fdf2f8 40%,#eef2ff)}
  @media(min-width:860px){ .bundle{grid-template-columns:1fr auto} }
  .bundle .title{font-size:20px;font-weight:800;margin:0}
  .bundle .desc{color:#64748b;margin:0}
  .bundle .mini{display:flex;gap:8px;align-items:center;margin:6px 0}
  .bundle .mini img{width:44px;height:60px;border-radius:8px;border:1px solid var(--line);object-fit:cover;box-shadow:0 4px 10px rgba(15,23,42,.06)}
  .bundle .badge{position:absolute;right:12px;top:-10px;background:#fff;border:1px solid var(--line);
                 padding:6px 10px;border-radius:999px;font-size:12px;color:#0f172a;box-shadow:0 6px 16px rgba(15,23,42,.08)}

  /* Drawer cart */
  .cart-toggle{position:fixed;right:16px;bottom:18px;z-index:40}
  .drawer{position:fixed;right:0;top:0;height:100dvh;width:380px;max-width:92vw;background:#fff;border-left:1px solid var(--line);box-shadow:-12px 0 30px rgba(15,23,42,.12);transform:translateX(100%);transition:transform .28s ease;z-index:50;display:flex;flex-direction:column}
  .drawer.open{transform:none}
  .drawer header{display:flex;justify-content:space-between;align-items:center;padding:14px;border-bottom:1px solid var(--line)}
  .drawer .list{flex:1;overflow:auto;padding:10px}
  .item{display:grid;grid-template-columns:56px 1fr auto;gap:10px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:8px;background:#fff;margin-bottom:10px}
  .item img{width:56px;height:76px;border-radius:8px;border:1px solid var(--line);object-fit:cover}
  .qty{display:inline-flex;align-items:center;border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .qty button{border:none;background:#fff;width:28px;height:28px;cursor:pointer}
  .qty span{display:inline-block;min-width:24px;text-align:center}
  .drawer footer{padding:14px;border-top:1px solid var(--line)}
  .row{display:flex;justify-content:space-between;align-items:center;margin:6px 0}
  .total{font-weight:800;font-size:20px}

  /* Modal quick view */
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(15,23,42,.35);z-index:60;padding:20px}
  .modal.open{display:grid}
  .modal .box{max-width:880px;width:100%;display:grid;grid-template-columns:1fr 1fr;gap:16px;background:#fff;border-radius:18px;border:1px solid var(--line);padding:16px}
  @media (max-width:860px){ .modal .box{grid-template-columns:1fr} }
  .modal img{width:100%;border-radius:12px;border:1px solid var(--line)}
  .modal h3{margin:0 0 6px}
  .modal .close{position:absolute;right:20px;top:20px;border:none;background:#fff;width:42px;height:42px;border-radius:999px;box-shadow:0 6px 18px rgba(15,23,42,.12);cursor:pointer}

  /* Minor */
  footer{margin-top:28px;text-align:center;color:#64748b}
  .illust{height:120px;border-radius:12px;background:linear-gradient(135deg,#fee2e2,#fce7f3);display:grid;place-items:center;font-size:42px}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">QS</div>
      <div>
        <h1>æˆ’ç³–è¨ˆç•« Quit Sugar</h1>
        <small class="muted">è¼•é¬†é–‹å§‹ã€æŒçºŒè¨˜éŒ„ã€çœ‹è¦‹æ”¹è®Š</small>
      </div>
    </div>
    <div class="muted">é›»å­æ›¸å•†åº—</div>
  </header>

  <nav class="top-nav">
    <a href="./">æˆ’ç³–é¦–é </a>
    <a href="./analyzer.html">é£Ÿç‰©å¡è·¯é‡Œåˆ†æå™¨</a>
    <a class="active" href="./ebooks.html">é›»å­æ›¸å•†åº—</a>
  </nav>

  <section class="hero">
    <div>
      <h2>é›»å­æ›¸å•†åº—</h2>
      <p class="muted">å¾å…¥é–€åˆ°é€²éšï¼Œå°‡ã€Œå°‘ç³–ã€è½åœ°åˆ°ä½ çš„æ¯ä¸€å¤©ã€‚å–®æœ¬é¸è³¼æˆ–ä¸€æ¬¡å…¥æ‰‹å¥—çµ„æ›´åˆ’ç®—ï¼Œçµå¸³æœƒå¸¶åˆ° Google è¡¨å–®å®Œæˆä¸‹å–®ã€‚</p>
      <div class="actions">
        <a class="btn primary" href="#bundle">æŸ¥çœ‹å¥—çµ„å„ªæƒ </a>
        <a class="btn" href="#list">ç€è¦½æ‰€æœ‰é›»å­æ›¸</a>
      </div>
    </div>
    <div class="hero-media">
      <picture>
        <source srcset="./assets/poster-reset-8w.webp" type="image/webp">
        <img src="./assets/poster-reset-8w.jpg" alt="8 é€±æˆ’ç³–å…¥é–€é›»å­æ›¸çš„å°é¢å±•ç¤º">
      </picture>
    </div>
  </section>

  <!-- Bundle banner -->
  <section id="bundle" class="bundle">
    <div>
      <div class="mini">
        <img src="./assets/poster-reset-8w.jpg" alt="8 é€±æˆ’ç³–å…¥é–€å°é¢ç¸®åœ–">
        <img src="./assets/poster-breakfast-20.jpg" alt="ä½ç³–æ—©é¤ 20 é“å°é¢ç¸®åœ–">
        <img src="./assets/poster-eating-out.jpg" alt="å¤–é£Ÿå°‘ç³–å°æŠ„å°é¢ç¸®åœ–">
        <img src="./assets/poster-desserts-15.jpg" alt="é›¶ç³–ç”œé» 15 é“å°é¢ç¸®åœ–">
      </div>
      <h3 class="title">Ebook Bundleï½œä¸€æ¬¡å…¥æ‰‹æœ€å¯¦ç”¨çš„ 4 æœ¬</h3>
      <p class="desc">ã€Œå…¥é–€ Ã— æ—©é¤ Ã— å¤–é£Ÿ Ã— ç”œé»ã€å®Œæ•´æ‰“åŒ…ï¼Œæ›´å®¹æ˜“å¾ç”Ÿæ´»å„é¢å‘å¯¦è¸å°‘ç³–ã€‚</p>
      <div class="actions">
        <button class="btn primary" id="add-bundle">åŠ å…¥è³¼ç‰©è»Š</button>
        <span class="badge">ğŸ å¥—çµ„åƒ¹ <span id="bundle-price">â€”</span>ï¼ˆçœ <span id="bundle-save">â€”</span>ï¼‰</span>
      </div>
    </div>
  </section>

  <!-- Filter & sort -->
  <div class="toolbar">
    <div class="chips" id="filters">
      <button class="chip active" data-filter="all">å…¨éƒ¨</button>
      <button class="chip" data-filter="beginner">å…¥é–€</button>
      <button class="chip" data-filter="breakfast">æ—©é¤</button>
      <button class="chip" data-filter="eatingout">å¤–é£Ÿ</button>
      <button class="chip" data-filter="desserts">ç”œé»</button>
    </div>
    <div>
      <label class="muted" for="sort">æ’åºï¼š</label>
      <select id="sort" class="sort">
        <option value="rec">æ¨è–¦</option>
        <option value="price-asc">åƒ¹æ ¼ ä½â†’é«˜</option>
        <option value="price-desc">åƒ¹æ ¼ é«˜â†’ä½</option>
        <option value="new">æœ€æ–°ä¸Šæ¶</option>
      </select>
    </div>
  </div>

  <!-- Product grid -->
  <section id="list" class="grid"></section>

  <footer>
    <p>Â© 2025 Quit Sugar. æ‰€æœ‰åƒ¹æ ¼ç‚ºæ–°å°å¹£ï¼ˆNT$ï¼‰ï¼Œç‚ºæ•¸ä½å•†å“ã€‚ä¸‹å–®å¾Œä½ æœƒæ”¶åˆ°é›»å­éƒµä»¶èˆ‡ä¸‹è¼‰é€£çµã€‚</p>
  </footer>
</div>

<!-- Cart floating button -->
<div class="cart-toggle">
  <button id="btn-cart" class="btn primary">ğŸ›’ è³¼ç‰©è»Šï¼ˆ<span id="cart-count">0</span>ï¼‰</button>
</div>

<!-- Drawer cart -->
<aside id="drawer" class="drawer" aria-hidden="true">
  <header>
    <strong>è³¼ç‰©è»Š</strong>
    <button id="cart-close" class="btn ghost">é—œé–‰</button>
  </header>
  <div class="list" id="cart-list"></div>
  <footer>
    <div class="row"><span class="muted">å°è¨ˆ</span><span id="sum-sub">NT$0</span></div>
    <div class="row"><span class="muted">æŠ˜æ‰£</span><span id="sum-off">- NT$0</span></div>
    <div class="row total"><span>åˆè¨ˆ</span><span id="sum-total">NT$0</span></div>
    <div class="row" style="margin-top:10px">
      <input id="coupon" placeholder="è¼¸å…¥æŠ˜æ‰£ç¢¼ï¼ˆä¾‹å¦‚ï¼šWELCOME10ï¼‰" style="flex:1;border:1px solid var(--line);border-radius:12px;padding:10px 12px"/>
      <button id="apply-coupon" class="btn">å¥—ç”¨</button>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="checkout" class="btn primary" style="width:100%;justify-content:center">å‰å¾€çµå¸³ï¼ˆGoogle è¡¨å–®ï¼‰</button>
    </div>
    <small class="muted">æç¤ºï¼šçµå¸³æœƒé–‹å•Ÿ Google è¡¨å–®ï¼Œæäº¤å¾Œæˆ‘å€‘å°‡äººå·¥å¯„é€ä¸‹è¼‰é€£çµã€‚</small>
  </footer>
</aside>

<!-- Quick view modal -->
<div id="modal" class="modal" aria-hidden="true">
  <button class="close" id="modal-close">âœ•</button>
  <div class="box">
    <div id="modal-cover"></div>
    <div>
      <h3 id="modal-title">â€”</h3>
      <div class="badges" id="modal-badges"></div>
      <p id="modal-desc" class="muted">â€”</p>
      <ul id="modal-bullets" class="muted" style="margin:0 0 8px 18px"></ul>
      <div class="price" style="margin:10px 0">
        <div class="now" id="modal-price">NT$â€”</div>
        <div class="was" id="modal-was" style="display:none">NT$â€”</div>
      </div>
      <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="modal-add" class="btn primary">åŠ å…¥è³¼ç‰©è»Š</button>
        <button id="modal-sample" class="btn">æŸ¥çœ‹è©¦é–±</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ========= ç”¢å“å®šç¾© ========= */
const PRODUCTS = [
  { id:'reset8w', name:'8 é€±æˆ’ç³–å…¥é–€ï¼ˆComplete Resetï¼‰', price:350, compareAt:440, tags:['beginner','new'],
    cover:{webp:'./assets/poster-reset-8w.webp', jpg:'./assets/poster-reset-8w.jpg', alt:'8 é€±æˆ’ç³–å…¥é–€é›»å­æ›¸å°é¢'},
    desc:'å¾ªåºæ¼¸é€²å®Œæˆ 8 é€±æ¸›ç³–æŒ‘æˆ°ï¼Œç©©å®šèƒ½é‡èˆ‡å¿ƒæƒ…çš„å…¥é–€æŒ‡å—ã€‚',
    bullets:['æ¯é€±è¡Œå‹•æ¸…å–®èˆ‡æª¢æ ¸è¡¨','ç„¡å£“åŠ›çš„æ›¿ä»£å»ºè­°','é¤ç›¤èˆ‡å‚™é¤æ¨¡æ¿'], sample:'#' },
  { id:'breakfast20', name:'ä½ç³–æ—©é¤ 20 é“', price:220, compareAt:null, tags:['breakfast'],
    cover:{webp:'./assets/poster-breakfast-20.webp', jpg:'./assets/poster-breakfast-20.jpg', alt:'ä½ç³–æ—©é¤ 20 é“é›»å­æ›¸å°é¢'},
    desc:'å¥½åƒã€å¥½åšã€å¥½å¸¶èµ°çš„æ¸…çˆ½æ—©é¤ï¼Œè®“ä¸€å¤©å¾è¼•ç”œé–‹å§‹ã€‚',
    bullets:['5 åˆ†é˜å®Œæˆçš„å¿«æ‰‹é¸é …','é«˜è›‹ç™½ã€é«˜çº–ç¶­æ­é…','å«ä¸€é€±æ—©é¤ç¯„ä¾‹èœå–®'], sample:'#' },
  { id:'eatingout', name:'å¤–é£Ÿå°‘ç³–å°æŠ„', price:180, compareAt:null, tags:['eatingout'],
    cover:{webp:'./assets/poster-eating-out.webp', jpg:'./assets/poster-eating-out.jpg', alt:'å¤–é£Ÿå°‘ç³–å°æŠ„é›»å­æ›¸å°é¢'},
    desc:'å¤–é£Ÿä¹Ÿå¯ä»¥å°‘ç³–ï¼šé»é¤é—œéµå­—ã€é£²æ–™æ›¿æ›èˆ‡é†¬æ±å°æŠ€å·§ã€‚',
    bullets:['å„æ–™ç†ç³»é»é¤æŒ‡å—','é£²æ–™ç”œåº¦æ›ç®—èˆ‡æ›¿ä»£','ä¾¿åˆ©å•†åº—å‹å–„æ¸…å–®'], sample:'#' },
  { id:'desserts15', name:'é›¶ç³–ç”œé» 15 é“', price:250, compareAt:290, tags:['desserts','sale'],
    cover:{webp:'./assets/poster-desserts-15.webp', jpg:'./assets/poster-desserts-15.jpg', alt:'é›¶ç³–ç”œé» 15 é“é›»å­æ›¸å°é¢'},
    desc:'æ»¿è¶³å„€å¼æ„Ÿåˆç„¡è² æ“”çš„ç”œé»ï¼ŒæŒæ¡æ§ç³–ä¹Ÿä¿ç•™å¿«æ¨‚ã€‚',
    bullets:['å®¶ç”¨çƒ¤ç®±å³å¯','ä»£ç³–ä½¿ç”¨èªªæ˜','æ¯ä»½ç‡Ÿé¤Šä¼°ç®—'], sample:'#' }
];
// å¥—çµ„æŠ˜æ‰£ï¼šæ¯”å–®è²·ç¸½å’Œä¾¿å®œ 20%
const BUNDLE = { id:'bundle4', name:'Ebook Bundleï¼ˆ4 æœ¬ï¼‰', contains:['reset8w','breakfast20','eatingout','desserts15'], discountRate:0.20 };

/* ========= Google è¡¨å–®çµå¸³è¨­å®šï¼ˆä½ æä¾›çš„è³‡æ–™ï¼‰ ========= */
const FORM = {
  url: 'https://forms.gle/gQGQkyC8BH6mk4D56',          // ä½ çš„è¡¨å–®ç¶²å€ï¼ˆçŸ­ç¶²å€ OKï¼‰
  entryKey: 'entry.1911580507'                          // å”¯ä¸€çš„æ–‡å­—æ¬„ä½ä»£è™Ÿï¼ˆå°‡æ”¾å…¥æ•´å¼µè¨‚å–®æ‘˜è¦ï¼‰
};
/* ==================================================== */

const $ = sel => document.querySelector(sel);
const $all = sel => Array.from(document.querySelectorAll(sel));
const money = n => 'NT$' + (Math.round(n).toLocaleString('zh-TW'));
const state = { filter:'all', sort:'rec', cart: loadCart(), coupon:null };

function loadCart(){ try{ return JSON.parse(localStorage.getItem('qs.cart.v1')) || []; }catch{ return []; } }
function saveCart(){ try{ localStorage.setItem('qs.cart.v1', JSON.stringify(state.cart)); }catch{} }

/* ========= æ¸²æŸ“ç”¢å“ ========= */
function badgeSpan(cls, text){ const s = document.createElement('span'); s.className='badge '+(cls||''); s.textContent=text; return s; }
function productCard(p){
  const card = document.createElement('div'); card.className='card product'; card.dataset.tags = p.tags.join(',');
  const pic = document.createElement('picture');
  const src = document.createElement('source'); src.srcset = p.cover.webp; src.type='image/webp';
  const img = document.createElement('img'); img.className='cover'; img.src = p.cover.jpg; img.alt = p.cover.alt;
  pic.append(src); pic.append(img);
  const title = document.createElement('h4'); title.textContent = p.name;
  const desc = document.createElement('p'); desc.className='muted'; desc.textContent = p.desc;
  const badges = document.createElement('div'); badges.className='badges';
  if(p.tags.includes('sale')) badges.append(badgeSpan('sale','ç‰¹åƒ¹'));
  if(p.tags.includes('new')) badges.append(badgeSpan('new','æ–°ä¸Šæ¶'));
  const price = document.createElement('div'); price.className='price';
  const now = document.createElement('div'); now.className='now'; now.textContent = money(p.price);
  price.append(now);
  if(p.compareAt){ const was = document.createElement('div'); was.className='was'; was.textContent = money(p.compareAt); price.append(was); }
  const actions = document.createElement('div'); actions.className='actions'; actions.style.display='flex'; actions.style.gap='8px'; actions.style.flexWrap='wrap';
  const btnAdd = document.createElement('button'); btnAdd.className='btn primary'; btnAdd.textContent='åŠ å…¥è³¼ç‰©è»Š';
  btnAdd.onclick = ()=> addToCart(p.id, 1);
  const btnView = document.createElement('button'); btnView.className='btn'; btnView.textContent='å¿«é€Ÿé è¦½';
  btnView.onclick = ()=> openModal(p.id);
  actions.append(btnAdd, btnView);
  card.append(pic, title, badges, desc, price, actions);
  return card;
}
function renderGrid(){
  const list = $('#list'); list.innerHTML = '';
  let arr = PRODUCTS.slice();
  if(state.filter !== 'all'){ arr = arr.filter(p => p.tags.includes(state.filter)); }
  if(state.sort === 'price-asc') arr.sort((a,b)=>a.price-b.price);
  if(state.sort === 'price-desc') arr.sort((a,b)=>b.price-a.price);
  if(state.sort === 'new') arr.sort((a,b)=>(b.tags.includes('new')?1:0)-(a.tags.includes('new')?1:0));
  arr.forEach(p => list.append(productCard(p)));
}

/* ========= å¥—çµ„åƒ¹æ ¼ ========= */
function calcBundle(){
  const sum = BUNDLE.contains.map(id => PRODUCTS.find(p=>p.id===id).price).reduce((a,b)=>a+b,0);
  const save = Math.round(sum * BUNDLE.discountRate);
  const bundlePrice = sum - save;
  $('#bundle-price').textContent = money(bundlePrice);
  $('#bundle-save').textContent = money(save);
  return { sum, save, price: bundlePrice };
}

/* ========= è³¼ç‰©è»Š ========= */
function addToCart(id, qty=1){
  const item = state.cart.find(x=>x.id===id);
  if(item){ item.qty += qty; } else { state.cart.push({ id, qty }); }
  saveCart(); updateCartUI(); toast('å·²åŠ å…¥è³¼ç‰©è»Š');
}
function removeFromCart(id){ state.cart = state.cart.filter(x=>x.id!==id); saveCart(); updateCartUI(); }
function setQty(id, qty){ const it = state.cart.find(x=>x.id===id); if(!it) return; it.qty = Math.max(1, qty|0); saveCart(); updateCartUI(); }

function cartLines(){
  return state.cart.map(x=>{
    if(x.id === BUNDLE.id){
      const b = calcBundle();
      return { id: x.id, name:BUNDLE.name, price:b.price, qty:x.qty, cover: PRODUCTS.find(p=>p.id==='reset8w').cover, isBundle:true };
    } else {
      const p = PRODUCTS.find(p=>p.id===x.id);
      return { id: p.id, name:p.name, price:p.price, qty:x.qty, cover:p.cover, isBundle:false };
    }
  });
}
function cartTotals(){
  const lines = cartLines();
  let sub = lines.reduce((s,l)=> s + l.price*l.qty, 0);
  let off = 0;
  if(state.coupon === 'WELCOME10'){ off = Math.round(sub * 0.10); }
  return { sub, off, total: sub - off };
}

/* ========= Google è¡¨å–®é å¡«é€£çµï¼ˆå–®ä¸€æ–‡å­—æ¬„ä½ï¼‰ ========= */
function buildFormURL(order){
  if(!FORM.url || !FORM.entryKey) return null;
  const u = new URL(FORM.url);
  const itemsLines = order.items.map(i=>`â€¢ ${i.name} Ã— ${i.qty} = ${i.unit * i.qty}`).join('\n');
  const payload =
`ã€è¨‚å–®å…§å®¹ã€‘
${itemsLines}
å°è¨ˆï¼š${order.sub}
æŠ˜æ‰£ï¼š${order.off}
åˆè¨ˆï¼š${order.total}${order.coupon ? `\næŠ˜æ‰£ç¢¼ï¼š${order.coupon}` : ''}

ï¼ˆè«‹ç¢ºèª Email èˆ‡å§“åå¾Œæäº¤ï¼Œæˆ‘å€‘æœƒå¯„é€ä¸‹è¼‰é€£çµï¼‰`;
  u.searchParams.set(FORM.entryKey, payload);
  return u.toString();
}

/* ========= ç¹ªè£½è³¼ç‰©è»Š ========= */
function renderCart(){
  const wrap = $('#cart-list'); wrap.innerHTML = '';
  const lines = cartLines();
  if(!lines.length){
    wrap.innerHTML = '<p class="muted" style="text-align:center;margin-top:16px">è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>';
  } else {
    lines.forEach(l=>{
      const row = document.createElement('div'); row.className='item';
      const pic = document.createElement('img'); pic.src = l.cover.jpg; pic.alt = l.name;
      const meta = document.createElement('div');
      meta.innerHTML = '<div style="font-weight:700">'+l.name+'</div><div class="muted">'+money(l.price)+'</div>';
      const right = document.createElement('div');
      const qty = document.createElement('div'); qty.className='qty';
      const minus = document.createElement('button'); minus.textContent='-';
      const num = document.createElement('span'); num.textContent = l.qty;
      const plus = document.createElement('button'); plus.textContent='+';
      minus.onclick = ()=>{ setQty(l.id, l.qty-1); };
      plus.onclick = ()=>{ setQty(l.id, l.qty+1); };
      qty.append(minus,num,plus);
      const del = document.createElement('button'); del.className='btn ghost'; del.textContent='ç§»é™¤';
      del.style.marginLeft='6px'; del.onclick = ()=> removeFromCart(l.id);
      right.append(qty, del);
      row.append(pic, meta, right);
      wrap.append(row);
    });
  }
  const t = cartTotals();
  $('#sum-sub').textContent = money(t.sub);
  $('#sum-off').textContent = '- ' + money(t.off);
  $('#sum-total').textContent = money(t.total);
}
function updateCartUI(){ $('#cart-count').textContent = state.cart.reduce((n,x)=>n+x.qty,0); renderCart(); }

/* ========= å¿«é€Ÿé è¦½ ========= */
function openModal(id){
  const p = PRODUCTS.find(x=>x.id===id); if(!p) return;
  const box = $('#modal'); box.classList.add('open'); box.setAttribute('aria-hidden','false');
  const coverWrap = $('#modal-cover'); coverWrap.innerHTML='';
  const pic = document.createElement('picture');
  const s = document.createElement('source'); s.srcset = p.cover.webp; s.type='image/webp';
  const img = document.createElement('img'); img.src = p.cover.jpg; img.alt = p.cover.alt;
  pic.append(s,img); coverWrap.append(pic);
  $('#modal-title').textContent = p.name;
  $('#modal-desc').textContent = p.desc;
  const badges = $('#modal-badges'); badges.innerHTML='';
  if(p.tags.includes('sale')) badges.append(badgeSpan('sale','ç‰¹åƒ¹'));
  if(p.tags.includes('new')) badges.append(badgeSpan('new','æ–°ä¸Šæ¶'));
  $('#modal-price').textContent = money(p.price);
  if(p.compareAt){ $('#modal-was').style.display='inline'; $('#modal-was').textContent = money(p.compareAt); } else { $('#modal-was').style.display='none'; }
  const ul = $('#modal-bullets'); ul.innerHTML='';
  (p.bullets||[]).forEach(t=>{ const li=document.createElement('li'); li.textContent=t; ul.append(li); });
  $('#modal-add').onclick = ()=> addToCart(p.id,1);
  $('#modal-sample').onclick = ()=> window.open(p.sample || '#','_blank','noopener');
}
function closeModal(){ const box = $('#modal'); box.classList.remove('open'); box.setAttribute('aria-hidden','true'); }

/* ========= äº‹ä»¶ç¶å®š ========= */
window.addEventListener('DOMContentLoaded', ()=>{
  renderGrid();
  calcBundle();

  // Filter / Sort
  Array.from(document.querySelectorAll('#filters .chip')).forEach(ch=>{
    ch.addEventListener('click', ()=>{
      Array.from(document.querySelectorAll('#filters .chip')).forEach(c=>c.classList.remove('active'));
      ch.classList.add('active'); state.filter = ch.dataset.filter; renderGrid();
    });
  });
  document.getElementById('sort').addEventListener('change', (e)=>{ state.sort = e.target.value; renderGrid(); });

  // Bundle åŠ å…¥è³¼ç‰©è»Š
  document.getElementById('add-bundle').addEventListener('click', ()=>{
    const existing = state.cart.find(x=>x.id===BUNDLE.id);
    if(existing){ existing.qty += 1; } else { state.cart.push({ id:BUNDLE.id, qty:1 }); }
    saveCart(); updateCartUI(); toast('å¥—çµ„å·²åŠ å…¥è³¼ç‰©è»Š');
  });

  // Drawer cart
  const drawer = document.getElementById('drawer');
  const openCart = ()=>{ drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); renderCart(); };
  const closeCart = ()=>{ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); };
  document.getElementById('btn-cart').addEventListener('click', openCart);
  document.getElementById('cart-close').addEventListener('click', closeCart);

  // Coupon
  document.getElementById('apply-coupon').addEventListener('click', ()=>{
    const code = (document.getElementById('coupon').value||'').trim().toUpperCase();
    if(!code){ state.coupon=null; updateCartUI(); toast('å·²æ¸…é™¤æŠ˜æ‰£ç¢¼'); return; }
    if(code==='WELCOME10'){ state.coupon=code; updateCartUI(); toast('å·²å¥—ç”¨ 9 æŠ˜'); }
    else { state.coupon=null; updateCartUI(); toast('æŠ˜æ‰£ç¢¼ç„¡æ•ˆ'); }
  });

  // çµå¸³ â†’ å°å‘ Google è¡¨å–®ï¼ˆé å¡«å–®ä¸€æ¬„ä½ï¼‰
  document.getElementById('checkout').addEventListener('click', ()=>{
    const lines = cartLines(); if(!lines.length){ toast('è³¼ç‰©è»Šæ˜¯ç©ºçš„'); return; }
    const t = cartTotals();
    const order = {
      items: lines.map(l=>({ id:l.id, name:l.name, qty:l.qty, unit:l.price })), // å–®åƒ¹ç”¨æ•¸å­—
      sub: t.sub, off: t.off, total: t.total, coupon: state.coupon
    };
    const url = buildFormURL(order);
    if(url){ window.open(url, '_blank', 'noopener'); }
    else{
      const txt = 'è¨‚å–®æ˜ç´°\n' + order.items.map(i=>`- ${i.name} Ã— ${i.qty}ï¼šNT$${i.unit*i.qty}`).join('\n')
        + `\nå°è¨ˆï¼šNT$${order.sub}\næŠ˜æ‰£ï¼š-NT$${order.off}\nåˆè¨ˆï¼šNT$${order.total}`
        + (order.coupon?`\næŠ˜æ‰£ç¢¼ï¼š${order.coupon}`:'');
      navigator.clipboard.writeText(txt).catch(()=>{});
      alert('å°šæœªè¨­å®šè¡¨å–®ç¶²å€ï¼Œå·²è¤‡è£½è¨‚å–®æ‘˜è¦ï¼š\n\n' + txt);
    }
  });

  updateCartUI();
});

/* ========= å°å·¥å…·ï¼štoast ========= */
function toast(msg){
  const n = document.createElement('div');
  n.textContent = msg;
  n.style.cssText = 'position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 10px 26px rgba(0,0,0,.2);z-index:70;opacity:0;transition:opacity .2s, transform .2s';
  document.body.appendChild(n);
  requestAnimationFrame(()=>{ n.style.opacity='1'; n.style.transform='translateX(-50%) translateY(-4px)'; });
  setTimeout(()=>{ n.style.opacity='0'; n.style.transform='translateX(-50%) translateY(0)'; setTimeout(()=>n.remove(),200); }, 1400);
}

/* ========= åœ–ç‰‡ fallbackï¼ˆé¿å…ç ´åœ–ï¼‰ ========= */
(function () {
  function fallback(node, emoji) {
    var ph = document.createElement('div');
    ph.className = 'illust';
    ph.textContent = emoji || 'ğŸ“˜';
    node.replaceWith(ph);
  }
  document.addEventListener('error', function(e){
    const img = e.target;
    if(img.tagName === 'IMG'){
      if (img.closest('.product')) return fallback(img, 'ğŸ“˜');
      if (img.closest('.bundle')) return fallback(img, 'ğŸ');
      fallback(img, 'ğŸ–¼ï¸');
    }
  }, true);
})();
</script>
</body>
</html>
