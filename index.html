<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æˆ’ç³–è¨ˆç•«ï½œQuit Sugar</title>
  <meta name="description" content="ç°¡å–®é–‹å§‹çš„æˆ’ç³–ç¶²ç«™ï¼šè¨»å†Šç™»å…¥ã€è¿½è¹¤é€£å‹ã€å¥åº·è¡Œå‹•æ¸…å–®èˆ‡æ¯æ—¥æ¿€å‹µã€‚" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --brand:#22c55e; --danger:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 600px at 80% -10%,#1f2937 0%,#0b1220 52%,#050816 100%),var(--bg);color:var(--text);font-family:'Noto Sans TC',system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    .wrap{max-width:980px;margin:0 auto;padding:32px 20px 80px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:24px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,#16a34a,#22c55e);display:grid;place-items:center;color:#04120b;font-weight:900}
    h1{margin:0;font-size:22px;letter-spacing:0.5px}
    .card{background:rgba(255,255,255,.04);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.06);border-radius:18px;padding:18px}
    .grid{display:grid;gap:16px}
    @media(min-width:960px){.grid{grid-template-columns:1.1fr 1fr}}
    h2{font-size:18px;margin:0 0 10px}
    h3{font-size:16px;margin:16px 0 8px}
    p,li,small{color:var(--muted)}
    input,button{font:inherit}
    input{width:100%;background:#0b1220;border:1px solid #22314a;padding:10px 12px;border-radius:10px;color:var(--text)}
    .row{display:grid;gap:10px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid #1f2937;padding:10px 14px;border-radius:12px;background:#0b1220;color:var(--text);cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,#16a34a,#22c55e);color:#04120b;border:none;font-weight:700}
    .btn.ghost{background:transparent}
    .btn.danger{background:linear-gradient(135deg,#ef4444,#b91c1c);border:none}
    .stat{display:flex;gap:14px;align-items:center}
    .stat .num{font-size:28px;font-weight:800}
    .kicker{display:inline-block;padding:4px 8px;border-radius:999px;background:#0b1220;border:1px solid #1f2937;color:#93c5fd;font-size:12px}
    .list{display:grid;gap:8px}
    .todo{display:flex;align-items:center;gap:10px}
    .todo input[type=checkbox]{width:18px;height:18px}
    .muted{color:var(--muted)}
    .error{border-left:3px solid var(--danger);padding:10px 12px;background:#160b0b;border-radius:12px}
    footer{margin-top:28px;text-align:center;color:var(--muted)}
    code{background:#0b1220;padding:2px 6px;border-radius:6px;border:1px solid #22314a}
  </style>
  <!-- Supabase JS CDN -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">QS</div>
      <div>
        <h1>æˆ’ç³–è¨ˆç•« Quit Sugar</h1>
        <small class="muted">è¼•é¬†é–‹å§‹ã€æŒçºŒè¨˜éŒ„ã€çœ‹è¦‹æ”¹è®Š</small>
      </div>
    </div>
    <div id="auth-quick" class="muted"></div>
  </header>

  <div class="grid">
    <!-- å·¦ï¼šå…§å®¹/æ¿€å‹µ & ä»£è¾¦ -->
    <section class="card">
      <span class="kicker">åŸºæœ¬åŸå‰‡ & æ¯æ—¥æ¿€å‹µ</span>
      <h2>ä»Šå¤©å°±é–‹å§‹ï¼Œå…ˆåšåˆ° 1 ä»¶å°äº‹</h2>
      <p id="motivation" class="muted">â€¦â€¦</p>
      <h3>å¥åº·è¡Œå‹•æ¸…å–®</h3>
      <div class="list" id="todo-list"></div>
      <div class="row2" style="margin-top:10px">
        <input id="todo-input" placeholder="+ æ–°å¢ä¸€å€‹ä»Šæ—¥å°è¡Œå‹•ï¼Œä¾‹å¦‚ï¼šæ™šé¤ä¸å–å«ç³–é£²æ–™"/>
        <button class="btn" id="todo-add">åŠ å…¥</button>
      </div>
    </section>

    <!-- å³ï¼šç™»å…¥/è¿½è¹¤ -->
    <section class="card">
      <span class="kicker">å€‹äººåŒ–è¿½è¹¤</span>
      <h2>è¨»å†Š / ç™»å…¥</h2>
      <div class="row2">
        <input id="signup-email" placeholder="Emailï¼ˆå»ºè­°æ‰‹å‹•è¼¸å…¥ï¼‰" autocomplete="username" />
        <input id="signup-password" placeholder="å¯†ç¢¼ï¼ˆè‡³å°‘ 6 ç¢¼ï¼‰" type="password" autocomplete="new-password" />
      </div>
      <div class="row2" style="margin-top:8px">
        <button class="btn primary" id="btn-signup">è¨»å†Š</button>
        <button class="btn" id="btn-login">ç™»å…¥</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn ghost" id="btn-logout" style="display:none">ç™»å‡º</button>
      </div>
      <div id="auth-error" class="error" style="display:none;margin-top:10px"></div>

      <hr style="margin:16px -18px;border-color:#1f2937;border-style:solid;border-width:1px 0 0"/>

      <h3>æˆ‘çš„æˆ’ç³–é‡Œç¨‹ç¢‘</h3>
      <div class="stat">
        <div>
          <div class="muted">ç•¶å‰é€£å‹ï¼ˆå¤©ï¼‰</div>
          <div class="num" id="current-streak">â€”</div>
        </div>
        <div>
          <div class="muted">æ­·å²æœ€é•·ï¼ˆå¤©ï¼‰</div>
          <div class="num" id="max-streak">â€”</div>
        </div>
      </div>
      <div class="row2" style="margin-top:12px">
        <button class="btn" id="btn-i-did-good">æˆ‘ä»Šå¤©æˆ’ç³– âœ…</button>
        <button class="btn danger" id="btn-reset">æˆ‘å¤±æ‰‹äº†ï¼Œé‡æ–°é–‹å§‹</button>
      </div>
      <small class="muted">æç¤ºï¼šç™»å…¥å¾Œæ‰æœƒå¯«å…¥/è®€å–è³‡æ–™è¡¨ <code>streaks</code>ã€‚</small>
    </section>
  </div>

  <footer>
    <p>Â© 2025 Quit Sugar. GitHub Pages Ã— Supabase</p>
  </footer>
</div>

<script>
  // ====== 1) Supabase é€£ç·šè¨­å®šï¼ˆä½¿ç”¨æ‚¨çš„å°ˆæ¡ˆè³‡è¨Šï¼‰ ======
  const SUPABASE_URL = "https://scquprvywjtuvcxxfsco.supabase.co"; // â† å·²å¥—ç”¨æ‚¨çš„ URL
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjcXVwcnZ5d2p0dXZjeHhmc2NvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MzAxMTQsImV4cCI6MjA3MTQwNjExNH0.iUZ_lI-mHoGoz2NfPTifYe44zieUIBUREF6fxsry97I"; // â† å·²å¥—ç”¨æ‚¨çš„ anon key
  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: false, // GitHub Pages ç„¡ SSRï¼Œé¿å… URL è§£æå¹²æ“¾
    }
  });

  // ====== 2) UI å°å·¥å…· ======
  const $ = (id) => document.getElementById(id);
  const showErr = (msg) => { const box = $("auth-error"); box.style.display = 'block'; box.textContent = msg; };
  const hideErr = () => { const box = $("auth-error"); box.style.display = 'none'; box.textContent = ''; };

  // ====== 3) Email æ­£è¦åŒ–ï¼ˆé¿å…ã€ŒEmail invalidã€ï¼‰ ======
  function normalizeEmail(raw) {
    return (raw ?? '')
      .normalize('NFKC')          // è½‰åŠå½¢
      .replace(/[\u200B-\u200D\uFEFF]/g, '') // å»é›¶å¯¬å­—å…ƒ
      .trim();
  }
  function basicEmailOK(s) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s); }

  // ====== 4) æ¿€å‹µèªå¥ ======
  const QUOTES = [
    'å°‘ç³–ä¸€é»ï¼Œæ¸…é†’å¤šä¸€é»ã€‚',
    'ä»Šå¤©çš„ä½ ï¼Œåªè¦æ¯”æ˜¨å¤©æ›´å¥½ 1%ã€‚',
    'æˆ’æ‰ä¸æ˜¯å¿«ç‹ æº–ï¼Œè€Œæ˜¯æŒçºŒåšå°äº‹ã€‚',
    'æƒ³åƒç”œçš„ï¼Ÿå…ˆå–ä¸€æ¯æ°´ï¼Œç­‰äº”åˆ†é˜å†æ±ºå®šã€‚',
    'æŠŠæ¸´æœ›å¯«ä¸‹ä¾†ï¼Œè®“å®ƒé›¢é–‹è…¦è¢‹ã€‚',
  ];
  function pickQuote(){
    const t = QUOTES[Math.floor(Math.random()*QUOTES.length)];
    $("motivation").textContent = t;
  }

  // ====== 5) TODOï¼ˆæœ¬åœ°å„²å­˜å³å¯ï¼‰ ======
  const TODO_KEY = 'qs.todos.v1';
  function readTodos(){ try { return JSON.parse(localStorage.getItem(TODO_KEY)) || []; } catch { return []; } }
  function writeTodos(list){ localStorage.setItem(TODO_KEY, JSON.stringify(list)); renderTodos(); }
  function renderTodos(){
    const list = readTodos();
    const wrap = $("todo-list");
    wrap.innerHTML='';
    list.forEach((t,i)=>{
      const row = document.createElement('div');
      row.className = 'todo';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!t.done; cb.addEventListener('change',()=>{ list[i].done = cb.checked; writeTodos(list); });
      const span = document.createElement('span'); span.textContent = t.text; span.className='muted';
      const del = document.createElement('button'); del.className='btn ghost'; del.textContent='åˆªé™¤'; del.addEventListener('click',()=>{ list.splice(i,1); writeTodos(list); });
      row.append(cb, span, del);
      wrap.append(row);
    });
  }

  // ====== 6) Authï¼šè¨»å†Š / ç™»å…¥ / ç™»å‡º ======
  async function signup(){
    hideErr();
    const email = normalizeEmail($("signup-email").value);
    const password = $("signup-password").value;
    if(!basicEmailOK(email)) return showErr('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Emailï¼ˆé¿å…å…¨å½¢èˆ‡å¤šé¤˜ç©ºç™½ï¼‰');
    if((password||'').length < 6) return showErr('å¯†ç¢¼è‡³å°‘ 6 ç¢¼');

    // è‹¥å°ˆæ¡ˆå·²é—œé–‰ Confirm emailï¼Œå°‡ç›´æ¥å»ºç«‹å¸³è™Ÿï¼›å¦å‰‡æœƒå¯„é©—è­‰ä¿¡
    const { data, error } = await supabaseClient.auth.signUp({ email, password });
    if(error){ return showErr('è¨»å†Šå¤±æ•—ï¼š' + (error.message || 'æœªçŸ¥éŒ¯èª¤')); }

    // æŸäº›æƒ…æ³ä¸‹éœ€è¦é©—è­‰ä¿¡ï¼Œæ­¤æ™‚ session æœƒæ˜¯ null
    if(!data.session){
      return showErr('å·²å¯„å‡ºé©—è­‰ä¿¡ï¼ˆè‹¥æœ‰å•Ÿç”¨ï¼‰ã€‚è«‹åˆ°ä¿¡ç®±ç¢ºèªå¾Œå›åˆ°æ­¤é ï¼Œå†æŒ‰ã€Œç™»å…¥ã€ã€‚');
    }
    await afterLogin();
  }

  async function login(){
    hideErr();
    const email = normalizeEmail($("signup-email").value);
    const password = $("signup-password").value;
    if(!basicEmailOK(email)) return showErr('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email');
    if((password||'').length < 6) return showErr('å¯†ç¢¼è‡³å°‘ 6 ç¢¼');

    const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
    if(error){ return showErr('ç™»å…¥å¤±æ•—ï¼š' + (error.message || 'æœªçŸ¥éŒ¯èª¤')); }
    await afterLogin();
  }

  async function logout(){
    await supabaseClient.auth.signOut();
    renderSession(null);
  }

  function renderSession(session){
    const quick = $("auth-quick");
    const btnLogout = $("btn-logout");
    if(session){
      const email = session.user?.email || 'å·²ç™»å…¥';
      quick.textContent = 'ğŸ‘¤ ' + email;
      btnLogout.style.display = 'inline-flex';
    }else{
      quick.textContent = 'æœªç™»å…¥';
      btnLogout.style.display = 'none';
      $("current-streak").textContent = 'â€”';
      $("max-streak").textContent = 'â€”';
    }
  }

  // ====== 7) Streaksï¼šé¦–æ¬¡ç™»å…¥è‡ªå‹•å»ºä¸€ç­†ï¼Œå¾ŒçºŒè®€å¯« ======
  function daysBetween(start){
    const s = new Date(start + 'T00:00:00');
    const today = new Date();
    const diff = Math.floor((Date.UTC(today.getFullYear(),today.getMonth(),today.getDate()) - Date.UTC(s.getFullYear(),s.getMonth(),s.getDate())) / (1000*60*60*24));
    return Math.max(0, diff+1); // ç•¶å¤©ç®—ç¬¬ 1 å¤©
  }

  async function ensureStreakRow(userId){
    const { data, error } = await supabaseClient.from('streaks').select('*').eq('user_id', userId).maybeSingle();
    if(error){ showErr('è®€å– streaks å¤±æ•—ï¼š' + error.message); return null; }
    if(data){ return data; }
    const today = new Date().toISOString().slice(0,10);
    const { data: inserted, error: e2 } = await supabaseClient.from('streaks').insert({
      user_id: userId,
      current_streak_start_date: today,
      max_streak_days: 0
    }).select().single();
    if(e2){ showErr('å»ºç«‹ streaks å¤±æ•—ï¼š' + e2.message); return null; }
    return inserted;
  }

  async function refreshStreaks(){
    const { data: { session } } = await supabaseClient.auth.getSession();
    if(!session){ return; }
    const row = await ensureStreakRow(session.user.id);
    if(!row) return;
    const current = daysBetween(row.current_streak_start_date);
    $("current-streak").textContent = current;
    $("max-streak").textContent = row.max_streak_days ?? 0;
  }

  async function markGoodToday(){
    const { data: { session } } = await supabaseClient.auth.getSession();
    if(!session) return showErr('è«‹å…ˆç™»å…¥');
    const row = await ensureStreakRow(session.user.id);
    if(!row) return;
    const current = daysBetween(row.current_streak_start_date);
    const newMax = Math.max(row.max_streak_days ?? 0, current);
    // ä¸é‡ç½®é–‹å§‹æ—¥ï¼Œåªæ›´æ–°æœ€é•·ç´€éŒ„ï¼ˆæ¯æ—¥å®ŒæˆæŒ‰éˆ•ï¼Œåƒ…ä½œæç¤ºï¼‰
    const { error } = await supabaseClient.from('streaks').update({ max_streak_days: newMax }).eq('user_id', session.user.id);
    if(error) return showErr('æ›´æ–°å¤±æ•—ï¼š' + error.message);
    await refreshStreaks();
  }

  async function resetStreak(){
    const { data: { session } } = await supabaseClient.auth.getSession();
    if(!session) return showErr('è«‹å…ˆç™»å…¥');
    const today = new Date().toISOString().slice(0,10);
    const { error } = await supabaseClient.from('streaks').update({ current_streak_start_date: today }).eq('user_id', session.user.id);
    if(error) return showErr('é‡ç½®å¤±æ•—ï¼š' + error.message);
    await refreshStreaks();
  }

  async function afterLogin(){
    const { data: { session } } = await supabaseClient.auth.getSession();
    renderSession(session);
    await refreshStreaks();
  }

  // ====== 8) ç¶å®šäº‹ä»¶ ======
  window.addEventListener('DOMContentLoaded', async () => {
    pickQuote();
    renderTodos();

    // todo
    $("todo-add").addEventListener('click', ()=>{
      const v = $("todo-input").value.trim();
      if(!v) return;
      const list = readTodos();
      list.unshift({ text:v, done:false });
      writeTodos(list);
      $("todo-input").value = '';
    });

    // auth
    $("btn-signup").addEventListener('click', signup);
    $("btn-login").addEventListener('click', login);
    $("btn-logout").addEventListener('click', logout);

    // streaks
    $("btn-i-did-good").addEventListener('click', markGoodToday);
    $("btn-reset").addEventListener('click', resetStreak);

    // Session åˆå§‹åŒ–
    const { data: { session } } = await supabaseClient.auth.getSession();
    renderSession(session);
    if(session){ await refreshStreaks(); }

    // ç›£è½ç™»å…¥ç‹€æ…‹è®ŠåŒ–
    supabaseClient.auth.onAuthStateChange((_evt, sess) => { renderSession(sess); if(sess){ refreshStreaks(); } });
  });
</script>

<!--
ã€å¾Œç«¯ä¸€æ¬¡æ€§è¨­å®šå‚™å¿˜ï¼ˆSupabaseï¼‰ã€‘
1) Auth â†’ Providers â†’ Emailï¼šå•Ÿç”¨ã€‚
   è‹¥æ¸¬è©¦æœŸï¼šAuth â†’ Email â†’ é—œé–‰ Confirm emailï¼ˆå…é©—è­‰å³å¯ç™»å…¥ï¼‰ã€‚
2) Auth â†’ URL Configurationï¼š
   Site URL åŠ Additional Redirect URLs å¡«ï¼š
   https://abbby9377.github.io/quit-sugar-site/
3) å»ºè¡¨èˆ‡ RLSï¼ˆè‹¥å°šæœªå»ºï¼‰ï¼šè«‹åˆ° SQL Editor åŸ·è¡Œä¸‹åˆ—æŒ‡ä»¤ï¼š

  create table if not exists public.streaks (
    id bigint generated by default as identity primary key,
    created_at timestamp with time zone default now(),
    user_id uuid not null default auth.uid() references auth.users(id) on delete cascade,
    current_streak_start_date date not null,
    max_streak_days bigint not null default 0
  );
  alter table public.streaks enable row level security;
  drop policy if exists "streaks_select_own" on public.streaks;
  create policy "streaks_select_own" on public.streaks for select to authenticated using (user_id = auth.uid());
  drop policy if exists "streaks_insert_self" on public.streaks;
  create policy "streaks_insert_self" on public.streaks for insert to authenticated with check (user_id = auth.uid());
  drop policy if exists "streaks_update_own" on public.streaks;
  create policy "streaks_update_own" on public.streaks for update to authenticated using (user_id = auth.uid()) with check (user_id = auth.uid());
  drop policy if exists "streaks_delete_own" on public.streaks;
  create policy "streaks_delete_own" on public.streaks for delete to authenticated using (user_id = auth.uid());
-->
</body>
</html>
