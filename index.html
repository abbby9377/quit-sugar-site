<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>戒糖計畫｜Quit Sugar</title>
  <meta name="description" content="輕鬆開始、持續記錄、看見改變：登入追蹤連勝、健康行動清單、每週挑戰與激勵語句，還有食物卡路里分析器、五行香水與電子書商店。"/>
  <meta name="theme-color" content="#f472b6" />

  <!-- 字體 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700;800&family=Noto+Serif+TC:wght@700&display=swap" rel="stylesheet">

  <style>
/* === 你原本的「Responsive 主導覽」設定（保留） === */
.nav { flex-wrap: wrap; }
.nav-links {
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
  max-width: 100%;
}
.nav-links a,
.nav-links .btn {
  font-size: clamp(13px, 3.4vw, 16px);
}
@media (max-width: 720px){
  .brand .logo{ width:36px; height:36px; border-radius:12px; }
  .brand .title{ font-size:18px; }
  .nav-links{
    gap:10px;
    flex: 1 1 100%;
    order: 2;
    overflow-x: auto;
    white-space: nowrap;
    padding-bottom: 6px;
    margin-top: 6px;
  }
  .nav-links a{
    padding: 6px 10px;
    border: 1px solid var(--line);
    border-radius: 999px;
    background:#fff;
  }
  .nav-links .btn{
    padding: 8px 12px;
  }
}

/* === 額外新增：漢堡鈕＋抽屜導覽樣式 === */
.burger{
  display:none; width:40px; height:40px; border:1px solid #e5e7eb;
  border-radius:10px; background:#fff; cursor:pointer;
  align-items:center; justify-content:center;
}
.burger span{display:block;width:20px;height:2px;background:#0b1220;margin:3px 0;border-radius:2px}
.mobile-drawer{
  position:fixed; inset:0 auto 0 0; width:86vw; max-width:320px; background:#fff;
  border-right:1px solid #e5e7eb; box-shadow:8px 0 30px rgba(15,23,42,.18);
  transform:translateX(-100%); transition:transform .25s ease; z-index:60;
  display:flex; flex-direction:column;
}
.mobile-drawer.open{ transform:none; }
.m-head{display:flex; justify-content:space-between; align-items:center; padding:14px; border-bottom:1px solid #e5e7eb}
.m-brand{width:36px;height:36px;border-radius:12px;display:grid;place-items:center;
  background:linear-gradient(135deg,#f472b6,#ec4899); color:#fff; font-weight:900}
.m-close{border:none;background:#fff;width:36px;height:36px;border-radius:10px;cursor:pointer}
.m-links{display:flex; flex-direction:column; gap:8px; padding:14px}
.m-links a{display:block; padding:12px 12px; border:1px solid #e5e7eb; border-radius:12px; background:#fff; color:#0b1220; text-decoration:none}
.m-links a.active{border-color:#d946ef;background:#fdf4ff}
.m-links .btn{justify-content:center}
.backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.38); z-index:55; }
.backdrop[hidden]{ display:none }
@media (max-width: 860px){
  .burger{ display:inline-flex; }
  .nav .nav-links{ display:none; } /* 手機以抽屜為主，隱藏桌機導覽 */
}

/* === 你原本的主題色與元件樣式（保留） === */
:root{
  --bg:#ffffff; --panel:#ffffff; --ink:#0b1220; --muted:#475569; --line:#e5e7eb;
  --brand:#ec4899; --brand-2:#f472b6; --brand-3:#fb7185;
  --accent:#fdf2f8; --promo:#fff1f5; --ok:#16a34a; --danger:#ef4444;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--ink);
  font-family:'Noto Sans TC',system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
img{max-width:100%;display:block}
a{color:#2563eb;text-decoration:none}
a:hover{text-decoration:underline}
.wrap{max-width:1120px;margin:0 auto;padding:0 20px 80px}

/* 促銷條 */
.promo{background:var(--promo);border-bottom:1px solid var(--line);text-align:center;padding:10px 12px;color:#7a294a;font-weight:700}
.promo .btn{margin-left:10px}
.promo .count{font-weight:800;margin-left:8px;color:#be185d}

/* Header */
header.site{position:sticky;top:0;background:#fff;z-index:20;border-bottom:1px solid var(--line)}
.nav{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:14px 0}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,var(--brand-2),var(--brand));display:grid;place-items:center;color:#fff;font-weight:900}
.title{margin:0;font-size:22px;letter-spacing:.3px}
.nav-links{display:flex;gap:16px;align-items:center}
.nav-links a.active{font-weight:800;color:#1d4ed8}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);padding:12px 16px;border-radius:999px;background:#fff;color:var(--ink);cursor:pointer;white-space:nowrap}
.btn.primary{background:linear-gradient(135deg,var(--brand-2),var(--brand));color:#fff;border:none;font-weight:800}
.btn.ghost{background:transparent}
.btn.danger{background:linear-gradient(135deg,#ef4444,#b91c1c);border:none;color:#fff}
.btn[disabled]{opacity:.6;cursor:not-allowed}

/* Hero */
.hero{background:linear-gradient(180deg,#fff,#fff 34%,#fdf2f8 34%,#fdf2f8);border-bottom:1px solid var(--line)}
.hero-inner{display:grid;gap:26px;align-items:center;padding:34px 0}
.eyebrow{display:inline-block;color:#a21caf;background:#fce7f3;border:1px solid #fbcfe8;padding:4px 10px;border-radius:999px;font-weight:700;font-size:12px;margin-bottom:8px}
.hero h1{font-family:"Noto Serif TC",serif;font-weight:700;font-size:34px;line-height:1.25;margin:0 0 10px;letter-spacing:.2px}
.hero p{color:#475569;margin:0 0 16px;max-width:60ch}
.hero-media{justify-self:end}
.hero-media img{width:min(260px,100%);height:auto;border-radius:24px;border:1px solid var(--line);box-shadow:0 20px 60px rgba(236,72,153,.15)}
.subnav{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.chip{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff}
.chip a{color:#334155;text-decoration:none}

/* Features */
.section-title{font-size:18px;margin:22px 0 10px}
.features{display:grid;gap:14px;}
.feature{background:#fff;border:1px solid var(--line);border-radius:16px;padding:14px}
.feature .feat-photo{width:100%;height:140px;border-radius:12px;object-fit:cover;border:1px solid var(--line)}
.feature h4{margin:8px 0 6px;font-size:15px}
.icon{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;margin-top:6px;background:linear-gradient(135deg,#fde68a,#fca5a5)}

/* Steps */
.steps{display:grid;gap:12px;margin:2px 0 20px;}
.step{background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;display:grid;gap:12px}
.step .thumb{width:100%;height:180px;border-radius:12px;object-fit:cover;border:1px solid var(--line)}
.step .num{font-weight:800;color:var(--brand)}

/* Carousel */
.carousel{position:relative;margin:2px 0 18px}
.car-track{display:flex;gap:12px;overflow-x:auto;scroll-snap-type:x mandatory;padding-bottom:6px}
.car-track::-webkit-scrollbar{height:8px}
.car-track::-webkit-scrollbar-thumb{background:#e5e7eb;border-radius:999px}
.recipe.cardish{scroll-snap-align:center;min-width:88%;background:#fff;border:1px solid var(--line);border-radius:16px;padding:14px}
.photo{width:100%;height:160px;border-radius:12px;object-fit:cover;margin-bottom:10px;border:1px solid var(--line)}
.car-btn{position:absolute;top:38%;transform:translateY(-50%);border:none;width:42px;height:42px;border-radius:999px;background:#fff;box-shadow:0 6px 16px rgba(15,23,42,.08);cursor:pointer;z-index:2}
.car-btn.prev{left:-10px}.car-btn.next{right:-10px}

/* Bundle CTA */
.bundle{position:relative;display:grid;gap:10px;align-items:center;
        border:1px solid var(--line);border-radius:20px;padding:18px;margin:14px 0 18px;
        background:linear-gradient(135deg,#fff1f2,#fdf2f8 40%,#eef2ff)}
.bundle .title{font-size:20px;font-weight:800;color:#0f172a;margin:0}
.bundle .desc{color:#64748b;margin:0}
.bundle .actions{display:flex;gap:10px;flex-wrap:wrap}
.bundle .badge{position:absolute;right:12px;top:-10px;background:#fff;border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-size:12px;color:#0f172a;box-shadow:0 6px 16px rgba(15,23,42,.08)}
.bundle .mini{display:flex;gap:8px;align-items:center}
.bundle .mini img{width:44px;height:60px;border-radius:8px;border:1px solid var(--line);object-fit:cover;box-shadow:0 4px 10px rgba(15,23,42,.06)}

/* 推薦電子書 */
.recs{margin:10px auto 24px}
.recs .grid{display:grid;gap:14px;}
.poster{background:#fff;border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:0 6px 20px rgba(236,72,153,.08);text-align:center}
.poster img{width:100%;border-radius:12px;border:1px solid var(--line)}
.poster .meta{font-size:12px;color:#64748b;margin-top:6px}
.poster .cta{margin-top:8px}
.poster .cta .btn{width:100%;justify-content:center}

/* Testimonials */
.testimonials{display:grid;gap:12px;margin:4px 0 20px;}
.quote{border-left:3px solid var(--brand);background:#fff;border:1px solid var(--line);padding:12px;border-radius:10px;display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:start}
.quote img.avatar{width:44px;height:44px;border-radius:999px;object-fit:cover;border:1px solid var(--line)}
.quote footer{margin-top:4px;color:#64748b}

/* FAQ */
details.faq{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
details.faq + details.faq{margin-top:10px}
details.faq summary{cursor:pointer;font-weight:600}

/* Auth + Streaks + Todo */
.grid-2{display:grid;gap:16px;}
.card{background:#fff;border:1px solid var(--line);border-radius:18px;padding:18px;box-shadow:0 6px 20px rgba(236,72,153,.08)}
.kicker{display:inline-block;padding:4px 10px;border-radius:999px;background:#fff;border:1px solid var(--line);color: var(--brand);font-size:12px;font-weight:700}
.row{display:grid;gap:10px}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
input{width:100%;background:#fff;border:1px solid #d1d5db;padding:10px 12px;border-radius:12px;color:var(--ink);font:inherit}
.stat{display:flex;gap:14px;align-items:center}
.stat .num{font-size:28px;font-weight:800}
.muted{color:var(--muted)}
.error{border-left:3px solid var(--danger);padding:10px 12px;background:#fff5f5;border-radius:12px}

/* 每週挑戰進度條 */
.progress-wrap{margin-top:10px}
.progress-bar{height:10px;background:#f1f5f9;border-radius:999px;overflow:hidden;border:1px solid var(--line)}
.progress-bar span{display:block;height:100%;width:0%;background:linear-gradient(135deg,var(--brand-2),var(--brand-3))}

/* 五行香水 */
.perfume{margin:20px 0}
.perf-grid{display:grid;gap:12px;}
.perf-card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:14px;text-align:center}
.perf-card .el{font-weight:800;margin-bottom:6px}
.pill{display:inline-block;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;color:#0f172a;margin:2px}

/* 徽章 */
.badges{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
.badge{display:flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#f8fafc;color:#64748b}
.badge.unlocked{background:#ecfeff;border-color:#67e8f9;color:#0e7490;font-weight:700}

/* 每日驚喜卡 */
.surprise{margin-top:14px;padding:14px;border:1px dashed #f9a8d4;border-radius:14px;background:#fff0f6}
.surprise .title{font-weight:800;margin-bottom:6px}

/* 動畫減量偏好 */
@media (prefers-reduced-motion: reduce){ .car-track{ scroll-behavior:auto; } }

/* --- 你的 RWD 段落（保留，略微補強 Hero 圖） --- */
.hero-inner{ grid-template-columns: 1fr; }
.features{ grid-template-columns: 1fr; }
.steps{ grid-template-columns: 1fr; }
.perf-grid{ grid-template-columns: 1fr; }
.bundle{ grid-template-columns: 1fr; }
.testimonials{ grid-template-columns: 1fr; }
.grid-2{ grid-template-columns: 1fr; }
.recs .grid{ grid-template-columns: 1fr; }
.carousel .recipe.cardish{ min-width: 88%; }
.hero-media img { width: min(260px, 100%); }

@media (min-width: 640px) {
  .features{ grid-template-columns: repeat(2, 1fr); }
  .perf-grid{ grid-template-columns: repeat(2, 1fr); }
  .recs .grid{ grid-template-columns: repeat(2, 1fr); }
  .carousel .recipe.cardish{ min-width: 48%; }
  .hero-media img { width: min(320px, 100%); }
}
@media (min-width: 768px) {
  .hero-inner{ grid-template-columns: 1.1fr 1fr; }
  .steps{ grid-template-columns: repeat(2, 1fr); }
  .carousel .recipe.cardish{ min-width: 42%; }
  .hero-media img { width: min(400px, 100%); }
}
@media(min-width:860px){
  .features{grid-template-columns:repeat(4,1fr)}
  .testimonials{grid-template-columns:repeat(2,1fr)}
  .bundle{grid-template-columns:1fr auto}
  .carousel .recipe.cardish{min-width:42%}
  .hero-media img { width: min(520px, 100%); }
}
@media(min-width:900px){
  .steps{grid-template-columns:repeat(3,1fr)}
  .perf-grid{grid-template-columns:repeat(5,1fr)}
  .recs .grid{grid-template-columns:repeat(4,1fr)}
}
@media(min-width:960px){
  .grid-2{grid-template-columns:1.1fr 1fr}
}
  </style>

  <!-- 全域錯誤顯示 -->
  <script>
    window.onerror = function(msg, src, line, col) {
      var box = document.getElementById('auth-error');
      if (box) { box.style.display = 'block'; box.textContent = '前端錯誤： ' + msg + ' (' + src + ':' + line + ':' + col + ')'; }
    };
  </script>

  <!-- Supabase SDK：主 CDN + 後備 -->
  <script>
    (function loadSupabaseSDK() {
      var primary = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js";
      var fallback = "https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js";
      function append(src) {
        var s = document.createElement('script');
        s.src = src; s.defer = true;
        s.onload = function(){ window.__supabaseReady = true; };
        s.onerror = function(){
          if (src === primary) {
            append(fallback);
          } else {
            var el = document.getElementById('auth-error');
            if (el) { el.style.display = 'block'; el.textContent = '載入 Supabase SDK 失敗，請稍後再試。'; }
          }
        };
        document.head.appendChild(s);
      }
      append(primary);
    })();
  </script>
</head>
<body>

  <!-- 促銷條（含倒數） -->
  <div class="promo" role="region" aria-label="促銷訊息">
    8 週戒糖 Reset｜首購 5 折倒數 <span class="count" id="promo-count" aria-live="polite">00:00:00</span>
    <a class="btn" href="#bundle" aria-label="立即加入">立即加入</a>
  </div>

  <!-- Header -->
  <header class="site" role="banner">
    <div class="wrap nav">
      <!-- 新增：行動版漢堡鈕 -->
      <button id="m-burger" class="burger" aria-label="開啟導覽" aria-controls="m-menu" aria-expanded="false">
        <span></span><span></span><span></span>
      </button>

      <div class="brand">
        <div class="logo" aria-hidden="true">QS</div>
        <div>
          <h1 class="title" style="margin:0">戒糖計畫 Quit Sugar</h1>
          <small class="muted">溫柔開始・持續記錄・看見改變</small>
        </div>
      </div>
      <nav class="nav-links" aria-label="主導覽">
        <a class="active" href="./">戒糖首頁</a>
        <a href="./element-quiz.html">五行測驗</a>
        <a href="./analyzer.html">食物卡路里分析器</a>
        <a href="./ebooks.html">電子書商店</a>
        <a class="btn primary" href="#auth">加入挑戰 / 登入</a>
      </nav>
    </div>
  </header>

  <!-- 新增：Mobile 抽屜導覽與遮罩（放在 header 後） -->
  <aside id="m-menu" class="mobile-drawer" aria-hidden="true">
    <header class="m-head">
      <div class="m-brand">QS</div>
      <button id="m-close" class="m-close" aria-label="關閉導覽">✕</button>
    </header>
    <nav id="m-nav" class="m-links" aria-label="行動版導覽"></nav>
  </aside>
  <div id="m-backdrop" class="backdrop" hidden></div>

  <!-- Hero -->
  <section class="hero">
    <div class="wrap hero-inner">
      <div>
        <span class="eyebrow">從今天開始</span>
        <h1>你的輕甜生活，從 1% 改變開始</h1>
        <p>給自己 8 週，換來更穩定的能量與好心情：每日 1 個小行動、每週微調。</p>
        <div class="actions" style="display:flex;gap:10px;flex-wrap:wrap">
          <a class="btn primary" href="#auth">加入挑戰 / 登入</a>
          <a class="btn" href="./element-quiz.html">做 60 秒五行測驗</a>
          <a class="btn" href="./ebooks.html">逛逛電子書商店</a>
        </div>
        <div class="subnav">
          <span class="chip"><a href="#why">為什麼有效</a></span>
          <span class="chip"><a href="#steps">三步驟開始</a></span>
          <span class="chip"><a href="#perfume">五行香水</a></span>
          <span class="chip"><a href="#recipes">食譜靈感</a></span>
          <span class="chip"><a href="#bundle">Ebook Bundle</a></span>
          <span class="chip"><a href="#stories">成功故事</a></span>
          <span class="chip"><a href="#faq">FAQ</a></span>
        </div>
      </div>

      <div class="hero-media" aria-hidden="true">
        <picture>
          <source srcset="./assets/feature-mind-body.webp" type="image/webp">
          <img
            src="./assets/feature-mind-body.jpg"
            alt="在瑜伽墊上冥想的女性，展現專注與身心平衡"
            fetchpriority="high"
            style="max-width:300px;width:70%;height:auto;"
          >
        </picture>
      </div>
    </div>
  </section>

  <main class="wrap" role="main">
    <!-- 四大重點 -->
    <h3 id="why" class="section-title">為什麼這個方法更溫柔、也更有效？</h3>
    <div class="features">
      <div class="feature">
        <picture><source srcset="./assets/feature-warm-approach.webp" type="image/webp"><img class="feat-photo" src="./assets/feature-warm-approach.jpg" alt="親和力十足的女性微笑肖像" loading="lazy" decoding="async"></picture>
        <div class="icon">💗</div>
        <h4>不必全或無</h4>
        <p class="muted">循序漸進的低糖節奏，搭配替代選擇，壓力更小、成功率更高。</p>
      </div>
      <div class="feature">
        <picture><source srcset="./assets/feature-tasty-low-sugar.webp" type="image/webp"><img class="feat-photo" src="./assets/feature-tasty-low-sugar.jpg" alt="低糖早餐碗與莓果巧克力" loading="lazy" decoding="async"></picture>
        <div class="icon">🥗</div>
        <h4>好吃也能少糖</h4>
        <p class="muted">簡單料理靈感與超市選物建議，日常就能做到。</p>
      </div>
      <div class="feature">
        <picture><source srcset="./assets/feature-mind-body.webp" type="image/webp"><img class="feat-photo" src="./assets/feature-mind-body.jpg" alt="運動與冥想的生活片段" loading="lazy" decoding="async"></picture>
        <div class="icon">🧘‍♀️</div>
        <h4>身心一起照顧</h4>
        <p class="muted">結合睡眠、壓力與簡易運動，讓渴望更好管理。</p>
      </div>
      <div class="feature">
        <picture><source srcset="./assets/feature-progress.webp" type="image/webp"><img class="feat-photo" src="./assets/feature-progress.jpg" alt="巧克力配莓果的份量控管" loading="lazy" decoding="async"></picture>
        <div class="icon">📈</div>
        <h4>看得見的成就</h4>
        <p class="muted">用「連勝天數」與「最長紀錄」追蹤進步，超有成就感。</p>
      </div>
    </div>

    <!-- 三步驟 -->
    <h3 id="steps" class="section-title">三步驟開始（今天就能做）</h3>
    <div class="steps">
      <div class="step">
        <div><div class="num">Step 1</div><strong>建立小目標</strong><p class="muted">選擇起始日與 1% 改變，邁出第一步。</p></div>
        <picture><source srcset="./assets/step1-goal.webp" type="image/webp"><img class="thumb" src="./assets/step1-goal.jpg" alt="規劃起點與目標的筆記與手寫畫面" loading="lazy" decoding="async"></picture>
      </div>
      <div class="step">
        <div><div class="num">Step 2</div><strong>每天 1 個小行動</strong><p class="muted">例如：晚餐不喝含糖飲料，或散步 20 分鐘。</p></div>
        <picture><source srcset="./assets/step2-action.webp" type="image/webp"><img class="thumb" src="./assets/step2-action.jpg" alt="日常可行的小行動與健康飲食" loading="lazy" decoding="async"></picture>
      </div>
      <div class="step">
        <div><div class="num">Step 3</div><strong>記錄成就、每週微調</strong><p class="muted">用連勝天數保持動力，依體感持續微調。</p></div>
        <picture><source srcset="./assets/step3-track.webp" type="image/webp"><img class="thumb" src="./assets/step3-track.jpg" alt="Habit tracker 與連勝介面" loading="lazy" decoding="async"></picture>
      </div>
    </div>

    <!-- 五行香水（僅展示） -->
    <section id="perfume" class="perfume">
      <h3 class="section-title">五行香水（Beta）</h3>
      <p class="muted">用五行找到你的專屬香：先做 <a href="./element-quiz.html">60 秒測驗</a>，再選主/副元素。</p>
      <div class="perf-grid">
        <div class="perf-card"><div class="el">木｜清新草木</div><div><span class="pill">綠意</span><span class="pill">草本</span><span class="pill">晨光</span></div></div>
        <div class="perf-card"><div class="el">火｜柑橘辛香</div><div><span class="pill">柑橘</span><span class="pill">辛香</span><span class="pill">活力</span></div></div>
        <div class="perf-card"><div class="el">土｜香草暖調</div><div><span class="pill">香草</span><span class="pill">安定</span><span class="pill">奶香</span></div></div>
        <div class="perf-card"><div class="el">金｜清透花香</div><div><span class="pill">花香</span><span class="pill">俐落</span><span class="pill">通透</span></div></div>
        <div class="perf-card"><div class="el">水｜海鹽麝香</div><div><span class="pill">海鹽</span><span class="pill">放鬆</span><span class="pill">白麝香</span></div></div>
      </div>
    </section>

    <!-- 食譜靈感 -->
    <h3 id="recipes" class="section-title">本週食譜靈感（左右滑動）</h3>
    <div class="carousel">
      <button class="car-btn prev" id="car-prev" aria-label="上一個">‹</button>
      <div class="car-track" id="car-track">
        <div class="recipe cardish">
          <picture><source srcset="./assets/feature-tasty-low-sugar.webp" type="image/webp"><img class="photo" src="./assets/feature-tasty-low-sugar.jpg" alt="低糖早餐碗：燕麥、堅果與水果" loading="lazy" decoding="async"></picture>
          <strong>暖胃燕麥碗</strong>
          <p class="muted">甜味來自香蕉與肉桂，早餐也能輕甜。</p>
          <a class="btn" href="./analyzer.html">用分析器估卡路里</a>
        </div>
        <div class="recipe cardish">
          <picture><source srcset="./assets/feature-progress.webp" type="image/webp"><img class="photo" src="./assets/feature-progress.jpg" alt="70% 黑巧克力搭配莓果" loading="lazy" decoding="async"></picture>
          <strong>70% 可可小點</strong>
          <p class="muted">想吃甜時的替代選擇，控制份量就不內疚。</p>
          <a class="btn" href="./analyzer.html">用分析器估卡路里</a>
        </div>
        <div class="recipe cardish">
          <picture><source srcset="./assets/feature-mind-body.webp" type="image/webp"><img class="photo" src="./assets/feature-mind-body.jpg" alt="地中海鮪魚沙拉：高蛋白、高纖維" loading="lazy" decoding="async"></picture>
          <strong>地中海鮪魚沙拉</strong>
          <p class="muted">高蛋白、高纖維，飽足感更久。</p>
          <a class="btn" href="./analyzer.html">用分析器估卡路里</a>
        </div>
      </div>
      <button class="car-btn next" id="car-next" aria-label="下一個">›</button>
    </div>

    <!-- Bundle -->
    <section id="bundle" class="bundle">
      <div>
        <div class="mini" style="margin-bottom:8px">
          <img src="./assets/poster-reset-8w.jpg" alt="8 週戒糖入門封面縮圖" loading="lazy" decoding="async">
          <img src="./assets/poster-breakfast-20.jpg" alt="低糖早餐 20 道封面縮圖" loading="lazy" decoding="async">
          <img src="./assets/poster-eating-out.jpg" alt="外食少糖小抄封面縮圖" loading="lazy" decoding="async">
          <img src="./assets/poster-desserts-15.jpg" alt="零糖甜點 15 道封面縮圖" loading="lazy" decoding="async">
        </div>
        <h3 class="title">Ebook Bundle｜一次入手最實用的 4 本指南</h3>
        <p class="desc">從 8 週戒糖入門到外食、早餐與零糖甜點，幫你把減糖落地到日常。</p>
        <div class="actions">
          <a class="btn primary" href="./ebooks.html">前往電子書商店</a>
          <a class="btn" href="./ebooks.html#bundle">了解套組優惠</a>
        </div>
      </div>
      <div class="right">
        <span class="badge">🎁 多本合購更划算</span>
      </div>
    </section>

    <!-- 成功故事 -->
    <h3 id="stories" class="section-title">成功故事</h3>
    <div class="testimonials">
      <blockquote class="quote">
        <img class="avatar" src="./assets/extras-testimonials.jpg" alt="Yumi 頭像" loading="lazy" decoding="async">
        <div><p>三週後下午崩壞消失了，皮膚也穩定許多！</p><footer>— Yumi．設計師</footer></div>
      </blockquote>
      <blockquote class="quote">
        <img class="avatar" src="./assets/extras-testimonials.jpg" alt="Irene 頭像" loading="lazy" decoding="async">
        <div><p>用「連勝」看進步，比體重計更激勵；現在甜飲一週只喝一次。</p><footer>— Irene．行銷人</footer></div>
      </blockquote>
    </div>

    <!-- FAQ -->
    <h3 id="faq" class="section-title">常見問題</h3>
    <details class="faq"><summary>一定要 8 週嗎？</summary><p class="muted">建議 8 週作為完整循環；也可依生活節奏調整。</p></details>
    <details class="faq"><summary>需要完全不吃糖嗎？</summary><p class="muted">不用極端；我們推「更少糖、少加工」，持續最重要。</p></details>

    <!-- 主要功能：激勵 / 待辦 / 登入與連勝 -->
    <div class="grid-2">
      <!-- 左側：激勵與代辦 -->
      <section class="card">
        <span class="kicker">基本原則 & 每日激勵</span>
        <h2>今天就開始，先做到 1 件小事</h2>
        <p id="motivation" class="muted">……</p>

        <!-- 每日驚喜卡 -->
        <div class="surprise" id="surprise">
          <div class="title">🎁 今日驚喜卡</div>
          <div class="muted" id="surprise-text">點一下抽卡，拿到今天的小任務或溫柔提醒。</div>
          <button class="btn" id="surprise-btn" type="button" style="margin-top:8px">抽一張</button>
        </div>

        <h3 style="margin-top:14px">健康行動清單</h3>
        <div class="list" id="todo-list"></div>
        <div class="row2" style="margin-top:10px">
          <input id="todo-input" placeholder="+ 新增一個今日小行動，例如：晚餐不喝含糖飲料"/>
          <button class="btn" id="todo-add">加入</button>
        </div>
      </section>

      <!-- 右側：登入與連勝 -->
      <section id="auth" class="card">
        <span class="kicker">個人化追蹤</span>
        <h2>註冊 / 登入</h2>
        <p class="muted" style="margin-top:-6px;margin-bottom:12px">註冊即可免費獲取每週戒糖電子報。</p>
        <div class="row2">
          <input id="signup-email" placeholder="Email（建議手動輸入）" autocomplete="username" />
          <input id="signup-password" placeholder="密碼（至少 6 碼）" type="password" autocomplete="new-password" />
        </div>
        <div class="row2" style="margin-top:8px">
          <button class="btn primary" id="btn-signup">註冊</button>
          <button class="btn" id="btn-login">登入</button>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn ghost" id="btn-logout" style="display:none">登出</button>
        </div>
        <div id="auth-error" class="error" style="display:none;margin-top:10px"></div>

        <hr style="margin:16px -18px;border-color:#e5e7eb;border-style:solid;border-width:1px 0 0"/>

        <h3>我的戒糖里程碑</h3>
        <div class="stat">
          <div><div class="muted">當前連勝（天）</div><div class="num" id="current-streak">—</div></div>
          <div><div class="muted">歷史最長（天）</div><div class="num" id="max-streak">—</div></div>
        </div>

        <!-- 徽章 -->
        <div class="badges" id="badge-list" aria-label="連勝徽章">
          <div class="badge" data-threshold="7">🏅 7 天</div>
          <div class="badge" data-threshold="14">🏆 14 天</div>
          <div class="badge" data-threshold="28">💎 28 天</div>
        </div>

        <!-- 每週挑戰 -->
        <div class="progress-wrap">
          <div class="muted" style="margin:8px 0 6px"><strong>每週挑戰：</strong>晚餐不喝含糖飲料</div>
          <div class="progress-bar"><span id="week-fill"></span></div>
          <small class="muted"><span id="week-label">本週完成 0 / 7 天</span></small>
        </div>

        <div class="row2" style="margin-top:12px">
          <button class="btn" id="btn-i-did-good" type="button">我今天戒糖 ✅</button>
          <button class="btn danger" id="btn-reset" type="button">我失手了，重新開始</button>
        </div>
        <small class="muted">提示：登入後才會寫入/讀取資料表 <code>streaks</code>。</small>
      </section>
    </div>
  </main>

  <footer class="wrap" role="contentinfo">
    <p>© 2025 Quit Sugar. GitHub Pages × Supabase</p>
  </footer>

<script>
  // ===== 延遲等待 SDK =====
  async function waitSupabaseReady(ms = 4000) {
    const start = Date.now();
    while (!window.supabase && Date.now() - start < ms) {
      await new Promise(r => setTimeout(r, 50));
    }
    return !!window.supabase;
  }

  // ===== 小工具 =====
  const $ = (id) => document.getElementById(id);
  const showErr = (msg) => { const box = $('auth-error'); if(!box) return; box.style.display = 'block'; box.textContent = msg; };
  const hideErr = () => { const box = $('auth-error'); if(!box) return; box.style.display = 'none'; box.textContent = ''; };

  // 倒數（促銷條）：預設 48 小時
  (function promoCountdown(){
    const el = $('promo-count'); if(!el) return;
    const end = Date.now() + 1000*60*60*48;
    const tick = () => {
      const left = Math.max(0, end - Date.now());
      const h = String(Math.floor(left/3600000)).padStart(2,'0');
      const m = String(Math.floor((left%3600000)/60000)).padStart(2,'0');
      const s = String(Math.floor((left%60000)/1000)).padStart(2,'0');
      el.textContent = `${h}:${m}:${s}`;
    };
    tick(); setInterval(tick, 1000);
  })();

  // 激勵語句
  const QUOTES = [
    '少糖一點，清醒多一點。','今天的你，只要比昨天更好 1%。',
    '戒掉不是快狠準，而是持續做小事。','想吃甜的？先喝一杯水，等五分鐘再決定。','把渴望寫下來，讓它離開腦袋。',
  ];
  function pickQuote(){ $('motivation').textContent = QUOTES[Math.floor(Math.random()*QUOTES.length)]; }

  // 日驚喜卡（每日一次）
  const SURPRISES = [
    '今晚改喝無糖氣泡水＋檸檬片 🍋',
    '睡前 5 分鐘伸展，幫助隔天不爆餓 🧘‍♀️',
    '把甜點分成兩次吃：現在一半，剩下留明天 ✂️',
    '外食先喝一杯水再點餐，飽足感 up 💧',
    '今天的甜味來源：莓果一小碗 🍓'
  ];
  function initSurprise(){
    const key = 'qs.surprise.' + new Date().toISOString().slice(0,10);
    const btn = $('surprise-btn'), box = $('surprise-text');
    const saved = localStorage.getItem(key);
    if(saved){ box.textContent = saved; btn.disabled = true; btn.textContent = '已抽卡'; return; }
    btn.addEventListener('click', ()=>{
      const pick = SURPRISES[Math.floor(Math.random()*SURPRISES.length)];
      box.textContent = pick;
      localStorage.setItem(key, pick);
      btn.disabled = true; btn.textContent = '已抽卡';
    });
  }

  // ===== TODO（本地儲存） =====
  const TODO_KEY = 'qs.todos.v1';
  function readTodos(){ try { return JSON.parse(localStorage.getItem(TODO_KEY)) || []; } catch { return []; } }
  function writeTodos(list){ localStorage.setItem(TODO_KEY, JSON.stringify(list)); renderTodos(); }
  function renderTodos(){
    const list = readTodos();
    const wrap = $('todo-list');
    wrap.innerHTML='';
    list.forEach((t,i)=>{
      const row = document.createElement('div');
      row.className = 'todo';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!t.done; cb.addEventListener('change',()=>{ list[i].done = cb.checked; writeTodos(list); });
      const span = document.createElement('span'); span.textContent = t.text; span.className='muted';
      const del = document.createElement('button'); del.className='btn ghost'; del.textContent='刪除'; del.addEventListener('click',()=>{ list.splice(i,1); writeTodos(list); });
      row.append(cb, span, del);
      wrap.append(row);
    });
  }

  // ===== 週進度（本地儲存） =====
  function isoWeek(d=new Date()){
    const t = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = t.getUTCDay() || 7;
    t.setUTCDate(t.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(t.getUTCFullYear(),0,1));
    const weekNum = Math.ceil((((t - yearStart)/86400000) + 1)/7);
    return {year: t.getUTCFullYear(), week: weekNum};
  }
  function todayStr(){ return new Date().toISOString().slice(0,10); }
  const WEEK_KEY_PREFIX = 'qs.weekMarks.';
  function weekKey(d=new Date()){ const w = isoWeek(d); return `${WEEK_KEY_PREFIX}${w.year}-${w.week.toString().padStart(2,'0')}`; }
  function getWeekSet(){ const raw = localStorage.getItem(weekKey()) || '[]'; try { return new Set(JSON.parse(raw)); } catch { return new Set(); } }
  function saveWeekSet(set){ localStorage.setItem(weekKey(), JSON.stringify(Array.from(set))); }
  function updateWeekUI(){
    const set = getWeekSet();
    const n = Math.min(7, set.size);
    const percent = (n/7)*100;
    $('week-fill').style.width = percent + '%';
    $('week-label').textContent = `本週完成 ${n} / 7 天`;
  }
  function recordTodayIfNew(){
    const set = getWeekSet();
    const t = todayStr();
    if(!set.has(t)){ set.add(t); saveWeekSet(set); }
    updateWeekUI();
  }

  // ===== 輪播初始化 =====
  function initCarousel(){
    const track = $('car-track');
    const prev = $('car-prev');
    const next = $('car-next');
    if(!track || !prev || !next) return;
    const firstCard = track.querySelector('.recipe');
    const gap = 12;
    const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const stepPx = () => (firstCard ? firstCard.clientWidth + gap : Math.max(300, track.clientWidth * 0.9));
    function updateArrows(){ const canScroll = track.scrollWidth > track.clientWidth + 1; prev.style.display = next.style.display = canScroll ? 'inline-flex' : 'none'; }
    prev.addEventListener('click', () => track.scrollBy({ left: -stepPx(), behavior: prefersReduced ? 'auto':'smooth' }));
    next.addEventListener('click', () => track.scrollBy({ left:  stepPx(), behavior: prefersReduced ? 'auto':'smooth' }));
    window.addEventListener('resize', updateArrows);
    updateArrows();
  }

  // ===== Supabase（你的專案） =====
  const SUPABASE_URL = "https://scquprvywjtuvcxxfsco.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjcXVwcnZ5d2p0dXZjeHhmc2NvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MzAxMTQsImV4cCI6MjA3MTQwNjExNH0.iUZ_lI-mHoGoz2NfPTifYe44zieUIBUREF6fxsry97I";
  let supabaseClient = null;

  // ===== 主流程 =====
  window.addEventListener('DOMContentLoaded', async () => {
    pickQuote();
    initSurprise();
    renderTodos();
    updateWeekUI();
    initCarousel();

    // 待辦事件
    $('todo-add').addEventListener('click', ()=>{
      const v = $('todo-input').value.trim();
      if(!v) return;
      const list = readTodos();
      list.unshift({ text:v, done:false });
      writeTodos(list);
      $('todo-input').value = '';
    });

    // 預先禁用需登入的按鈕
    $('btn-i-did-good').disabled = true;
    $('btn-reset').disabled = true;

    // 等待 Supabase
    const ok = await waitSupabaseReady(4000);
    if (!ok) { showErr('Supabase SDK 未載入完成，登入/連勝功能暫不可用；其他功能正常。'); return; }

    // 初始化 client
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: false }
    });

    // Auth
    function normalizeEmail(raw){ return (raw ?? '').normalize('NFKC').replace(/[\u200B-\u200D\uFEFF]/g, '').trim(); }
    function basicEmailOK(s){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s); }

    async function signup(){
      hideErr();
      const email = normalizeEmail($('signup-email').value);
      const password = $('signup-password').value;
      if(!basicEmailOK(email)) return showErr('請輸入有效的 Email');
      if((password||'').length < 6) return showErr('密碼至少 6 碼');
      const { data, error } = await supabaseClient.auth.signUp({ email, password });
      if(error){ return showErr('註冊失敗：' + (error.message || '未知錯誤')); }
      if(!data.session){ return showErr('若啟用信箱驗證，請至信箱收信後再回來按「登入」。'); }
      await afterLogin();
    }

    async function login(){
      hideErr();
      const email = normalizeEmail($('signup-email').value);
      const password = $('signup-password').value;
      if(!basicEmailOK(email)) return showErr('請輸入有效的 Email');
      if((password||'').length < 6) return showErr('密碼至少 6 碼');
      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if(error){ return showErr('登入失敗：' + (error.message || '未知錯誤')); }
      await afterLogin();
    }

    async function logout(){ await supabaseClient.auth.signOut(); renderSession(null); }

    function renderSession(session){
      const quickBtns = ['btn-i-did-good','btn-reset'];
      if(session){
        document.querySelector('.nav-links .btn.primary').textContent = session.user?.email || '已登入';
        document.getElementById('btn-logout').style.display = 'inline-flex';
        quickBtns.forEach(id=>$(id).disabled=false);
      }else{
        document.querySelector('.nav-links .btn.primary').textContent = '加入挑戰 / 登入';
        document.getElementById('btn-logout').style.display = 'none';
        $('current-streak').textContent = '—';
        $('max-streak').textContent = '—';
        quickBtns.forEach(id=>$(id).disabled=true);
      }
    }

    // Streaks
    function daysBetween(start){
      const s = new Date(start + 'T00:00:00');
      const today = new Date();
      const diff = Math.floor((Date.UTC(today.getFullYear(),today.getMonth(),today.getDate()) - Date.UTC(s.getFullYear(),s.getMonth(),s.getDate())) / (1000*60*60*24));
      return Math.max(0, diff+1);
    }

    async function ensureStreakRow(userId){
      const { data, error } = await supabaseClient.from('streaks').select('*').eq('user_id', userId).maybeSingle();
      if(error){ showErr('讀取 streaks 失敗：' + error.message); return null; }
      if(data){ return data; }
      const today = new Date().toISOString().slice(0,10);
      const { data: inserted, error: e2 } = await supabaseClient.from('streaks').insert({
        user_id: userId, current_streak_start_date: today, max_streak_days: 0
      }).select().single();
      if(e2){ showErr('建立 streaks 失敗：' + e2.message); return null; }
      return inserted;
    }

    function updateBadgesUI(currentDays){
      const list = document.querySelectorAll('#badge-list .badge');
      list.forEach(b=>{
        const need = Number(b.getAttribute('data-threshold')||0);
        b.classList.toggle('unlocked', currentDays >= need);
      });
    }

    async function refreshStreaks(){
      const { data: { session } } = await supabaseClient.auth.getSession();
      if(!session){ return; }
      const row = await ensureStreakRow(session.user.id);
      if(!row) return;
      const current = daysBetween(row.current_streak_start_date);
      $('current-streak').textContent = current;
      $('max-streak').textContent = row.max_streak_days ?? 0;
      updateBadgesUI(current);
    }

    async function markGoodToday(){
      const { data: { session } } = await supabaseClient.auth.getSession();
      if(!session) return showErr('請先登入');
      const row = await ensureStreakRow(session.user.id);
      if(!row) return;
      const current = daysBetween(row.current_streak_start_date);
      const newMax = Math.max(row.max_streak_days ?? 0, current);
      const { error } = await supabaseClient.from('streaks').update({ max_streak_days: newMax }).eq('user_id', session.user.id);
      if(error) return showErr('更新失敗：' + error.message);
      recordTodayIfNew();
      await refreshStreaks();
    }

    async function resetStreak(){
      const { data: { session } } = await supabaseClient.auth.getSession();
      if(!session) return showErr('請先登入');
      const today = new Date().toISOString().slice(0,10);
      const { error } = await supabaseClient.from('streaks').update({ current_streak_start_date: today }).eq('user_id', session.user.id);
      if(error) return showErr('重置失敗：' + error.message);
      await refreshStreaks();
    }

    async function afterLogin(){
      const { data: { session } } = await supabaseClient.auth.getSession();
      renderSession(session);
      await refreshStreaks();
    }

    // 綁定
    $('btn-signup').addEventListener('click', signup);
    $('btn-login').addEventListener('click', login);
    $('btn-logout').addEventListener('click', logout);
    $('btn-i-did-good').addEventListener('click', markGoodToday);
    $('btn-reset').addEventListener('click', resetStreak);

    // 初始化 Session
    const { data: { session } } = await supabaseClient.auth.getSession();
    renderSession(session);
    if(session){ await refreshStreaks(); }

    // 監聽登入狀態
    supabaseClient.auth.onAuthStateChange(function(_evt, sess){ renderSession(sess); if(sess){ refreshStreaks(); } });
  });

  // 圖片 fallback（避免破圖）
  (function () {
    function fallback(node, emoji) {
      var ph = document.createElement('div');
      ph.className = 'photo';
      ph.style.display='grid'; ph.style.placeItems='center'; ph.style.background='#f8fafc'; ph.style.border='1px solid var(--line)'; ph.style.borderRadius='12px';
      ph.textContent = emoji || '🖼️';
      node.replaceWith(ph);
    }
    document.addEventListener('error', function(e){
      const img = e.target;
      if(img.tagName === 'IMG'){
        if (img.closest('.feature')) return fallback(img, '📷');
        if (img.closest('.step')) return fallback(img, '🧩');
        if (img.closest('.recipe')) return fallback(img, '🥗');
        if (img.closest('.bundle')) return fallback(img, '🎁');
        fallback(img, '🖼️');
      }
    }, true);
  })();

  /* === 新增：漢堡抽屜導覽 JS === */
  (function(){
    var desktopNav = document.querySelector('.nav-links');
    var mobileNav  = document.getElementById('m-nav');
    var burger     = document.getElementById('m-burger');
    var drawer     = document.getElementById('m-menu');
    var backdrop   = document.getElementById('m-backdrop');
    var closeBtn   = document.getElementById('m-close');
    if (!desktopNav || !mobileNav || !burger || !drawer || !backdrop || !closeBtn) return;

    // 複製桌面導覽內容到行動抽屜
    mobileNav.innerHTML = desktopNav.innerHTML;

    function openDrawer(){
      drawer.classList.add('open');
      backdrop.hidden = false;
      burger.setAttribute('aria-expanded','true');
      document.body.style.overflow = 'hidden';
    }
    function closeDrawer(){
      drawer.classList.remove('open');
      backdrop.hidden = true;
      burger.setAttribute('aria-expanded','false');
      document.body.style.overflow = '';
    }
    burger.addEventListener('click', openDrawer);
    closeBtn.addEventListener('click', closeDrawer);
    backdrop.addEventListener('click', closeDrawer);
    document.addEventListener('keydown', function(e){ if(e.key === 'Escape') closeDrawer(); });
    mobileNav.addEventListener('click', function(e){ if (e.target.tagName === 'A') closeDrawer(); });
  })();
</script>

</body>
</html>
