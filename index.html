<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æˆ’ç³–è¨ˆç•«ï½œQuit Sugar</title>
  <meta name="description" content="ç°¡å–®é–‹å§‹çš„æˆ’ç³–ç¶²ç«™ï¼šè¨»å†Šç™»å…¥ã€è¿½è¹¤é€£å‹ã€å¥åº·è¡Œå‹•æ¸…å–®èˆ‡æ¯æ—¥æ¿€å‹µã€‚" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#ffffff; --card:#ffffff; --muted:#4b5563; --text:#111827; --brand:#22c55e; --danger:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;background:#ffffff;color:var(--text);font-family:'Noto Sans TC',system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    .wrap{max-width:980px;margin:0 auto;padding:32px 20px 80px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,#16a34a,#22c55e);display:grid;place-items:center;color:#04120b;font-weight:900}
    h1{margin:0;font-size:22px;letter-spacing:0.5px}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:18px;padding:18px}
    .grid{display:grid;gap:16px}
    @media(min-width:960px){.grid{grid-template-columns:1.1fr 1fr}}
    h2{font-size:18px;margin:0 0 10px}
    h3{font-size:16px;margin:16px 0 8px}
    p,li,small{color:var(--muted)}
    input,button{font:inherit}
    input{width:100%;background:#ffffff;border:1px solid #d1d5db;padding:10px 12px;border-radius:10px;color:var(--text)}
    .row{display:grid;gap:10px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid #e5e7eb;padding:10px 14px;border-radius:12px;background:#f9fafb;color:var(--text);cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,#16a34a,#22c55e);color:#04120b;border:none;font-weight:700}
    .btn.ghost{background:transparent}
    .btn.danger{background:linear-gradient(135deg,#ef4444,#b91c1c);border:none;color:#fff}
    .stat{display:flex;gap:14px;align-items:center}
    .stat .num{font-size:28px;font-weight:800}
    .kicker{display:inline-block;padding:4px 8px;border-radius:999px;background:#f1f5f9;border:1px solid #e5e7eb;color:#2563eb;font-size:12px}
    .list{display:grid;gap:8px}
    .todo{display:flex;align-items:center;gap:10px}
    .todo input[type=checkbox]{width:18px;height:18px}
    .muted{color:var(--muted)}
    .error{border-left:3px solid var(--danger);padding:10px 12px;background:#fff5f5;border-radius:12px}
    footer{margin-top:28px;text-align:center;color:var(--muted)}
    code{background:#f1f5f9;padding:2px 6px;border-radius:6px;border:1px solid #e5e7eb}
    hr{border-color:#e5e7eb;}
    nav.top-nav{display:flex;gap:12px;align-items:center;padding:8px 0 12px;margin:0 0 16px;border-bottom:1px solid #e5e7eb;}
    nav.top-nav a{color:#2563eb;text-decoration:none}
    nav.top-nav a:hover{text-decoration:underline}
      /* === åƒè€ƒ iquitsugar.com çš„ç‰ˆå‹å…ƒç´ ï¼ˆä¸è¤‡è£½æ–‡å­—èˆ‡ç´ æï¼‰=== */
    .hero{background:#f9fafb;border:1px solid #e5e7eb;border-radius:20px;padding:20px;margin:8px 0 20px}
    .hero h2{font-size:26px;margin:0 0 8px}
    .hero p{margin:0 0 12px}
    .hero .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn.cta{background:linear-gradient(135deg,#16a34a,#22c55e);color:#04120b;border:none;font-weight:700}
    .btn.secondary{background:#eef2ff;border:1px solid #e5e7eb}

    .section-title{font-size:18px;margin:18px 0 10px}
    .features{display:grid;gap:12px;margin:0 0 20px}
    @media(min-width:800px){.features{grid-template-columns:repeat(4,1fr)}}
    .feature{background:#ffffff;border:1px solid #e5e7eb;border-radius:14px;padding:14px}
    .feature h4{margin:0 0 6px;font-size:15px}

    .testimonials{display:grid;gap:12px;margin:4px 0 20px}
    @media(min-width:800px){.testimonials{grid-template-columns:repeat(2,1fr)}}
    .quote{border-left:3px solid #22c55e;background:#f6fdf9;padding:12px;border-radius:10px}
    .quote footer{margin-top:6px;color:#4b5563}

    details.faq{border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff}
    details.faq + details.faq{margin-top:10px}
    details.faq summary{cursor:pointer;font-weight:600}
  </style>

  <!-- å…¨åŸŸéŒ¯èª¤é¡¯ç¤ºï¼ˆä¾¿æ–¼æ’éŒ¯ï¼‰ -->
  <script>
    window.onerror = function(msg, src, line, col) {
      var box = document.getElementById('auth-error');
      if (box) { box.style.display = 'block'; box.textContent = 'å‰ç«¯éŒ¯èª¤ï¼š ' + msg + ' (' + src + ':' + line + ':' + col + ')'; }
    };
  </script>

  <!-- é›™ CDNï¼šå…ˆè¼‰ jsDelivrï¼Œå¤±æ•—å‰‡åˆ‡åˆ° unpkgï¼›è¼‰å…¥å®Œæˆå¾Œæ‰åŸ·è¡Œä¸»ç¨‹å¼ -->
  <script>
    (function loadSupabaseSDK() {
      var primary = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js";
      var fallback = "https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js";
      function append(src) {
        var s = document.createElement('script');
        s.src = src; s.defer = true;
        s.onload = function(){ window.__supabaseReady = true; };
        s.onerror = function(){
          if (src === primary) {
            append(fallback);
          } else {
            var el = document.getElementById('auth-error');
            if (el) { el.style.display = 'block'; el.textContent = 'è¼‰å…¥ Supabase SDK å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼ˆæˆ–æª¢æŸ¥æ˜¯å¦è¢«ç¶²è·¯æ“‹ä½ CDNï¼‰ã€‚'; }
          }
        };
        document.head.appendChild(s);
      }
      append(primary);
    })();
  </script>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">QS</div>
      <div>
        <h1>æˆ’ç³–è¨ˆç•« Quit Sugar</h1>
        <small class="muted">è¼•é¬†é–‹å§‹ã€æŒçºŒè¨˜éŒ„ã€çœ‹è¦‹æ”¹è®Š</small>
      </div>
    </div>
    <div id="auth-quick" class="muted"></div>
  </header>

  <!-- å°è¦½åˆ—ï¼ˆç«™å…§é é¢ï¼‰ -->
  <nav class="top-nav">
    <a href="./">æˆ’ç³–é¦–é </a>
    <a href="./analyzer.html">é£Ÿç‰©å¡è·¯é‡Œåˆ†æå™¨</a>
  </nav>

  <!-- Hero å€ï¼ˆéˆæ„Ÿä¾†è‡ª iquitsugar.com çš„æ¸…æ¥š CTAï¼‰ -->
  <section class="hero">
    <h2>ä½ çš„å¥åº·é‡å•Ÿï¼Œå¾ä»Šå¤©é–‹å§‹</h2>
    <p class="muted">åŠ å…¥ 8 é€±æˆ’ç³–æŒ‘æˆ°ï¼šæ¯é€±è¡Œå‹•æ¸…å–®ã€å‹å–„çš„é¤å–®å»ºè­°ã€ç°¡æ˜“é‹å‹•èˆ‡ç¤¾ç¾¤æ”¯æŒã€‚</p>
    <div class="actions">
      <a class="btn cta" href="#auth">åŠ å…¥æŒ‘æˆ° / ç™»å…¥</a>
      <a class="btn secondary" href="./analyzer.html">å…ˆè©¦ç”¨é£Ÿç‰©å¡è·¯é‡Œåˆ†æå™¨</a>
    </div>
  </section>

  <!-- å››å¤§é‡é»ï¼ˆä¸è¤‡è£½åŸç«™ç´ æï¼Œåƒ…åƒè€ƒçµæ§‹ï¼‰ -->
  <h3 class="section-title">å››å€‹ä½ æœƒå–œæ­¡çš„é‡é»</h3>
  <div class="features">
    <div class="feature"><h4>å®¢è£½åŒ–ç¯€å¥</h4><p class="muted">ä¸ç”¨ä¸€æ¬¡å…¨æˆ’ï¼Œå¾ªåºæ¼¸é€²ï¼›é©åˆå¿™ç¢Œä¹Ÿèƒ½åšå¾—åˆ°ã€‚</p></div>
    <div class="feature"><h4>é¤å–®éˆæ„Ÿ</h4><p class="muted">æä¾›ä½ç³–æ–™ç†éˆæ„Ÿèˆ‡æ›¿ä»£æ–¹æ¡ˆï¼Œå¯¦ç”¨å¥½ä¸Šæ‰‹ã€‚</p></div>
    <div class="feature"><h4>ç¤¾ç¾¤æ”¯æŒ</h4><p class="muted">ä¸€èµ·æŒ‘æˆ°æ›´ä¸å­¤å–®ï¼Œåˆ†äº«å¿ƒå¾—ã€æ›´æœ‰å‹•åŠ›ã€‚</p></div>
    <div class="feature"><h4>å¯è¦–åŒ–æˆå°±</h4><p class="muted">ä»¥ã€Œé€£å‹å¤©æ•¸ã€èˆ‡ã€Œæœ€é•·ç´€éŒ„ã€è¿½è¹¤ä½ çš„é€²æ­¥ã€‚</p></div>
  </div>

  <!-- ç²¾é¸å¿ƒå¾—ï¼ˆå¼•ç”¨æ ¼å¼ï¼Œæ–‡å­—ç‚ºè‡ªæ’°ç¤ºä¾‹ï¼‰ -->
  <h3 class="section-title">ä½¿ç”¨è€…å›é¥‹</h3>
  <div class="testimonials">
    <blockquote class="quote">
      <p>é€£åšä¸‰é€±å¾Œï¼Œä¸‹åˆç²¾ç¥ä¸‹é™çš„ç‹€æ³æ˜é¡¯æ”¹å–„ï¼Œä¸‹ç­é‚„æœ‰åŠ›æ°£é‹å‹•ï¼</p>
      <footer>â€” Hsuanï¼ä¸Šç­æ—</footer>
    </blockquote>
    <blockquote class="quote">
      <p>ä¸æ˜¯å®Œå…¨ä¸åƒç”œï¼Œè€Œæ˜¯å­¸æœƒé¸æ“‡ã€‚é¤å¾Œå°‘ç³–æ°´æœå–ä»£è›‹ç³•ï¼Œè¶…æœ‰æ„Ÿã€‚</p>
      <footer>â€” Mingï¼å…©å¯¶åª½</footer>
    </blockquote>
  </div>

  <!-- FAQï¼ˆæ¡ç”¨ details/summaryï¼‰ -->
  <h3 class="section-title">å¸¸è¦‹å•é¡Œ</h3>
  <details class="faq"><summary>ä¸€å®šè¦ 8 é€±å—ï¼Ÿ</summary><p class="muted">å»ºè­° 8 é€±ä½œç‚ºä¸€å€‹å®Œæ•´å¾ªç’°ï¼›ä¹Ÿå¯ä»¥ä¾ä½ çš„ç”Ÿæ´»ç¯€å¥èª¿æ•´ã€‚</p></details>
  <details class="faq"><summary>éœ€è¦å®Œå…¨ä¸åƒç³–å—ï¼Ÿ</summary><p class="muted">ä¸ç”¨æ¥µç«¯ï¼›æˆ‘å€‘æ¨ä½ç³–ã€å°‘åŠ å·¥ï¼Œé‡è¦–å¯æŒçºŒã€‚</p></details>

  <div class="grid">
    <!-- å·¦ï¼šå…§å®¹/æ¿€å‹µ & ä»£è¾¦ -->
    <section class="card">
      <span class="kicker">åŸºæœ¬åŸå‰‡ & æ¯æ—¥æ¿€å‹µ</span>
      <h2>ä»Šå¤©å°±é–‹å§‹ï¼Œå…ˆåšåˆ° 1 ä»¶å°äº‹</h2>
      <p id="motivation" class="muted">â€¦â€¦</p>
      <h3>å¥åº·è¡Œå‹•æ¸…å–®</h3>
      <div class="list" id="todo-list"></div>
      <div class="row2" style="margin-top:10px">
        <input id="todo-input" placeholder="+ æ–°å¢ä¸€å€‹ä»Šæ—¥å°è¡Œå‹•ï¼Œä¾‹å¦‚ï¼šæ™šé¤ä¸å–å«ç³–é£²æ–™"/>
        <button class="btn" id="todo-add">åŠ å…¥</button>
      </div>
    </section>

    <!-- å³ï¼šç™»å…¥/è¿½è¹¤ -->
    <section id="auth" class="card">
      <span class="kicker">å€‹äººåŒ–è¿½è¹¤</span>
      <h2>è¨»å†Š / ç™»å…¥</h2>
      <div class="row2">
        <input id="signup-email" placeholder="Emailï¼ˆå»ºè­°æ‰‹å‹•è¼¸å…¥ï¼‰" autocomplete="username" />
        <input id="signup-password" placeholder="å¯†ç¢¼ï¼ˆè‡³å°‘ 6 ç¢¼ï¼‰" type="password" autocomplete="new-password" />
      </div>
      <div class="row2" style="margin-top:8px">
        <button class="btn primary" id="btn-signup">è¨»å†Š</button>
        <button class="btn" id="btn-login">ç™»å…¥</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn ghost" id="btn-logout" style="display:none">ç™»å‡º</button>
      </div>
      <div id="auth-error" class="error" style="display:none;margin-top:10px"></div>

      <hr style="margin:16px -18px;border-color:#e5e7eb;border-style:solid;border-width:1px 0 0"/>

      <h3>æˆ‘çš„æˆ’ç³–é‡Œç¨‹ç¢‘</h3>
      <div class="stat">
        <div>
          <div class="muted">ç•¶å‰é€£å‹ï¼ˆå¤©ï¼‰</div>
          <div class="num" id="current-streak">â€”</div>
        </div>
        <div>
          <div class="muted">æ­·å²æœ€é•·ï¼ˆå¤©ï¼‰</div>
          <div class="num" id="max-streak">â€”</div>
        </div>
      </div>
      <div class="row2" style="margin-top:12px">
        <button class="btn" id="btn-i-did-good">æˆ‘ä»Šå¤©æˆ’ç³– âœ…</button>
        <button class="btn danger" id="btn-reset">æˆ‘å¤±æ‰‹äº†ï¼Œé‡æ–°é–‹å§‹</button>
      </div>
      <small class="muted">æç¤ºï¼šç™»å…¥å¾Œæ‰æœƒå¯«å…¥/è®€å–è³‡æ–™è¡¨ <code>streaks</code>ã€‚</small>
    </section>
  </div>

  <footer>
    <p>Â© 2025 Quit Sugar. GitHub Pages Ã— Supabase</p>
  </footer>
</div>

<script>
  // ====== å»¶é²ç­‰å¾… SDK è¼‰å…¥å®Œæˆ ======
  async function waitSupabaseReady(ms = 4000) {
    const start = Date.now();
    while (!window.supabase && Date.now() - start < ms) {
      await new Promise(r => setTimeout(r, 50));
    }
    return !!window.supabase;
  }

  // ====== UI å°å·¥å…· ======
  const $ = (id) => document.getElementById(id);
  const showErr = (msg) => { const box = document.getElementById('auth-error'); if(!box) return; box.style.display = 'block'; box.textContent = msg; };
  const hideErr = () => { const box = document.getElementById('auth-error'); if(!box) return; box.style.display = 'none'; box.textContent = ''; };

  // ====== Email æ­£è¦åŒ–ï¼ˆé¿å…ã€ŒEmail invalidã€ï¼‰ ======
  function normalizeEmail(raw) {
    return (raw ?? '')
      .normalize('NFKC')
      .replace(/[\u200B-\u200D\uFEFF]/g, '')
      .trim();
  }
  function basicEmailOK(s) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s); }

  // ====== æ¿€å‹µèªå¥ ======
  const QUOTES = [
    'å°‘ç³–ä¸€é»ï¼Œæ¸…é†’å¤šä¸€é»ã€‚',
    'ä»Šå¤©çš„ä½ ï¼Œåªè¦æ¯”æ˜¨å¤©æ›´å¥½ 1%ã€‚',
    'æˆ’æ‰ä¸æ˜¯å¿«ç‹ æº–ï¼Œè€Œæ˜¯æŒçºŒåšå°äº‹ã€‚',
    'æƒ³åƒç”œçš„ï¼Ÿå…ˆå–ä¸€æ¯æ°´ï¼Œç­‰äº”åˆ†é˜å†æ±ºå®šã€‚',
    'æŠŠæ¸´æœ›å¯«ä¸‹ä¾†ï¼Œè®“å®ƒé›¢é–‹è…¦è¢‹ã€‚',
  ];
  function pickQuote(){
    const t = QUOTES[Math.floor(Math.random()*QUOTES.length)];
    document.getElementById('motivation').textContent = t;
  }

  // ====== TODOï¼ˆæœ¬åœ°å„²å­˜ï¼‰ ======
  const TODO_KEY = 'qs.todos.v1';
  function readTodos(){ try { return JSON.parse(localStorage.getItem(TODO_KEY)) || []; } catch { return []; } }
  function writeTodos(list){ localStorage.setItem(TODO_KEY, JSON.stringify(list)); renderTodos(); }
  function renderTodos(){
    const list = readTodos();
    const wrap = document.getElementById('todo-list');
    wrap.innerHTML='';
    list.forEach((t,i)=>{
      const row = document.createElement('div');
      row.className = 'todo';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!t.done; cb.addEventListener('change',()=>{ list[i].done = cb.checked; writeTodos(list); });
      const span = document.createElement('span'); span.textContent = t.text; span.className='muted';
      const del = document.createElement('button'); del.className='btn ghost'; del.textContent='åˆªé™¤'; del.addEventListener('click',()=>{ list.splice(i,1); writeTodos(list); });
      row.append(cb, span, del);
      wrap.append(row);
    });
  }

  // ====== ä¸»æµç¨‹ ======
  window.addEventListener('DOMContentLoaded', async () => {
    pickQuote();
    renderTodos();

    // ç­‰å¾… Supabase SDK
    const ok = await waitSupabaseReady(4000);
    if (!ok) { showErr('Supabase SDK æœªè¼‰å…¥å®Œæˆï¼Œè«‹é‡æ–°æ•´ç†æˆ–ç¨å¾Œå†è©¦ã€‚'); return; }

    // 1) Supabase é€£ç·šè¨­å®šï¼ˆä½¿ç”¨ä½ çš„å°ˆæ¡ˆè³‡è¨Šï¼‰
    const SUPABASE_URL = "https://scquprvywjtuvcxxfsco.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjcXVwcnZ5d2p0dXZjeHhmc2NvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MzAxMTQsImV4cCI6MjA3MTQwNjExNH0.iUZ_lI-mHoGoz2NfPTifYe44zieUIBUREF6fxsry97I";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: false }
    });

    // Authï¼šè¨»å†Š / ç™»å…¥ / ç™»å‡º
    async function signup(){
      hideErr();
      const email = normalizeEmail(document.getElementById('signup-email').value);
      const password = document.getElementById('signup-password').value;
      if(!basicEmailOK(email)) return showErr('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Emailï¼ˆé¿å…å…¨å½¢èˆ‡å¤šé¤˜ç©ºç™½ï¼‰');
      if((password||'').length < 6) return showErr('å¯†ç¢¼è‡³å°‘ 6 ç¢¼');
      const { data, error } = await supabaseClient.auth.signUp({ email, password });
      if(error){ return showErr('è¨»å†Šå¤±æ•—ï¼š' + (error.message || 'æœªçŸ¥éŒ¯èª¤')); }
      if(!data.session){ return showErr('è‹¥å•Ÿç”¨ä¿¡ç®±é©—è­‰ï¼Œè«‹è‡³ä¿¡ç®±æ”¶ä¿¡å¾Œå†å›ä¾†æŒ‰ã€Œç™»å…¥ã€ã€‚'); }
      await afterLogin();
    }

    async function login(){
      hideErr();
      const email = normalizeEmail(document.getElementById('signup-email').value);
      const password = document.getElementById('signup-password').value;
      if(!basicEmailOK(email)) return showErr('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email');
      if((password||'').length < 6) return showErr('å¯†ç¢¼è‡³å°‘ 6 ç¢¼');
      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if(error){ return showErr('ç™»å…¥å¤±æ•—ï¼š' + (error.message || 'æœªçŸ¥éŒ¯èª¤')); }
      await afterLogin();
    }

    async function logout(){ await supabaseClient.auth.signOut(); renderSession(null); }

    function renderSession(session){
      const quick = document.getElementById('auth-quick');
      const btnLogout = document.getElementById('btn-logout');
      if(session){
        const email = session.user?.email || 'å·²ç™»å…¥';
        quick.textContent = 'ğŸ‘¤ ' + email;
        btnLogout.style.display = 'inline-flex';
      }else{
        quick.textContent = 'æœªç™»å…¥';
        btnLogout.style.display = 'none';
        document.getElementById('current-streak').textContent = 'â€”';
        document.getElementById('max-streak').textContent = 'â€”';
      }
    }

    // Streaks
    function daysBetween(start){
      const s = new Date(start + 'T00:00:00');
      const today = new Date();
      const diff = Math.floor((Date.UTC(today.getFullYear(),today.getMonth(),today.getDate()) - Date.UTC(s.getFullYear(),s.getMonth(),s.getDate())) / (1000*60*60*24));
      return Math.max(0, diff+1);
    }

    async function ensureStreakRow(userId){
      const { data, error } = await supabaseClient.from('streaks').select('*').eq('user_id', userId).maybeSingle();
      if(error){ showErr('è®€å– streaks å¤±æ•—ï¼š' + error.message); return null; }
      if(data){ return data; }
      const today = new Date().toISOString().slice(0,10);
      const { data: inserted, error: e2 } = await supabaseClient.from('streaks').insert({
        user_id: userId,
        current_streak_start_date: today,
        max_streak_days: 0
      }).select().single();
      if(e2){ showErr('å»ºç«‹ streaks å¤±æ•—ï¼š' + e2.message); return null; }
      return inserted;
    }

    async function refreshStreaks(){
      const { data: { session } } = await supabaseClient.auth.getSession();
      if(!session){ return; }
      const row = await ensureStreakRow(session.user.id);
      if(!row) return;
      const current = daysBetween(row.current_streak_start_date);
      document.getElementById('current-streak').textContent = current;
      document.getElementById('max-streak').textContent = row.max_streak_days ?? 0;
    }

    async function markGoodToday(){
      const { data: { session } } = await supabaseClient.auth.getSession();
      if(!session) return showErr('è«‹å…ˆç™»å…¥');
      const row = await ensureStreakRow(session.user.id);
      if(!row) return;
      const current = daysBetween(row.current_streak_start_date);
      const newMax = Math.max(row.max_streak_days ?? 0, current);
      const { error } = await supabaseClient.from('streaks').update({ max_streak_days: newMax }).eq('user_id', session.user.id);
      if(error) return showErr('æ›´æ–°å¤±æ•—ï¼š' + error.message);
      await refreshStreaks();
    }

    async function resetStreak(){
      const { data: { session } } = await supabaseClient.auth.getSession();
      if(!session) return showErr('è«‹å…ˆç™»å…¥');
      const today = new Date().toISOString().slice(0,10);
      const { error } = await supabaseClient.from('streaks').update({ current_streak_start_date: today }).eq('user_id', session.user.id);
      if(error) return showErr('é‡ç½®å¤±æ•—ï¼š' + error.message);
      await refreshStreaks();
    }

    async function afterLogin(){
      const { data: { session } } = await supabaseClient.auth.getSession();
      renderSession(session);
      await refreshStreaks();
    }

    // ç¶å®šäº‹ä»¶
    document.getElementById('todo-add').addEventListener('click', ()=>{
      const v = document.getElementById('todo-input').value.trim();
      if(!v) return;
      const list = readTodos();
      list.unshift({ text:v, done:false });
      writeTodos(list);
      document.getElementById('todo-input').value = '';
    });
    document.getElementById('btn-signup').addEventListener('click', signup);
    document.getElementById('btn-login').addEventListener('click', login);
    document.getElementById('btn-logout').addEventListener('click', logout);
    document.getElementById('btn-i-did-good').addEventListener('click', markGoodToday);
    document.getElementById('btn-reset').addEventListener('click', resetStreak);

    // Session åˆå§‹åŒ–
    const { data: { session } } = await supabaseClient.auth.getSession();
    renderSession(session);
    if(session){ await refreshStreaks(); }

    // ç›£è½ç™»å…¥ç‹€æ…‹
    supabaseClient.auth.onAuthStateChange(function(_evt, sess){ renderSession(sess); if(sess){ refreshStreaks(); } });
  });
</script>

<!-- å¾Œç«¯ä¸€æ¬¡æ€§è¨­å®šå‚™å¿˜ï¼ˆSupabaseï¼‰
1) Auth â†’ Providers â†’ Emailï¼šå•Ÿç”¨ã€‚
   æ¸¬è©¦æœŸå¯åœ¨ Auth â†’ Email é—œé–‰ Confirm emailã€‚
2) Auth â†’ URL Configurationï¼š
   Site URL/Redirect URL éƒ½å¡«ï¼šhttps://abbby9377.github.io/quit-sugar-site/
3) å»ºè¡¨èˆ‡ RLSï¼ˆè‹¥æœªå»ºï¼‰ï¼šåœ¨ SQL Editor åŸ·è¡Œï¼š

  create table if not exists public.streaks (
    id bigint generated by default as identity primary key,
    created_at timestamp with time zone default now(),
    user_id uuid not null default auth.uid() references auth.users(id) on delete cascade,
    current_streak_start_date date not null,
    max_streak_days bigint not null default 0
  );
  alter table public.streaks enable row level security;
  drop policy if exists "streaks_select_own" on public.streaks;
  create policy "streaks_select_own" on public.streaks for select to authenticated using (user_id = auth.uid());
  drop policy if exists "streaks_insert_self" on public.streaks;
  create policy "streaks_insert_self" on public.streaks for insert to authenticated with check (user_id = auth.uid());
  drop policy if exists "streaks_update_own" on public.streaks;
  create policy "streaks_update_own" on public.streaks for update to authenticated using (user_id = auth.uid()) with check (user_id = auth.uid());
  drop policy if exists "streaks_delete_own" on public.streaks;
  create policy "streaks_delete_own" on public.streaks for delete to authenticated using (user_id = auth.uid());
-->
</body>
</html>
